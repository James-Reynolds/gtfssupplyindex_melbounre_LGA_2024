---
title: "City of Bayside: social needs, gaps in transit"
runningheader: "City of Bayside:needs-gaps" # only for pdf output
author: "Dr James Reynolds"
date: "`r Sys.Date()`"
bibliography: References.bib
csl: https://www.zotero.org/styles/chicago-fullnote-bibliography-16th-edition
suppress-bibliography: yes
output:
#  tufte::tufte_html: default
  tufte::tufte_handout:
#    citation_package: natbib
#    latex_engine: xelatex
#  tufte::tufte_book:
#    citation_package: natbib
#    latex_engine: xelatex


---

```{r setup, include=FALSE}
library(tufte)
library(tidyverse)
library(tidytransit)
library(sp)
library(strayr)
library(ptinpoly)
library(magrittr)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(janitor)
library(mapview)
library(ggstatsplot)
library(gtsummary)
library(moments)
library(scales)
library(gtfstools)
library(lubridate)
library(kableExtra)
library(knitr)
library(readxl)
library(readr)
library(dplyr)
library(devtools)
library(gtfssupplyindex)
library(readabs)
library(gglorenz)
library(DescTools)
library(RColorBrewer)
library(lsr)
library(ggpubr)
library(viridis)
library(geosphere)
library(png)
library(absmapsdata)
library(tidytransit)
library(patchwork)

lga_of_interest_2016 <- absmapsdata::lga2016 %>% filter(lga_name_2016 == "Bayside (C)")

lga_of_interest_2021 <- absmapsdata::lga2021 %>% filter(lga_name_2021 == "Bayside (Vic.)")


```

In Victoria, public transport is managed by the state government, although Local Government Authorities (LGAs) may have some influence on service levels through planning processes, advocacy etc. However, not much is known about how much transit is supplied or whether social needs for transport are being met within each LGA's boundaries. This note explores social needs-gaps in the City of Bayside, using the Currie and Sendbergs (2007) methodology[@Currie2007Identifying; @currie2010identifying]. It is part of a series examining each LGA in Greater Melbourne^[See https://github.com/James-Reynolds/gtfssupplyindex_melbounre_LGA_2024 but lookout, I misspelled "Melbourne" ]. 

# Methods 
This note maps public transport supply and a composite needs indicator based on Australian Bureau of Statistics (ABS) data. The methodology is as per Reynolds, Currie and Qu (in drafting)^[Forthcoming hopefully, but using the *gtfssupplyindex* R package (see https://github.com/James-Reynolds/gtfssupplyindex) to process the Victoria GTFS feed. Note that results represent what is in the GTFS feed for August 2021 and October 2024, which may not match services provided.]. The Transit Supply Indication (SI) scores are based on the frequency of service and how much of an area is within walking distance of stops/stations^[400m for tram and bus, 800m for train.], are reported for the ABS' Statistical Area 1s (SA1s), and are categorized into seven groups based on the average scores for SA1s across the Melbourne Greater Capital City Statistical Area (GCCSA).


```{r fix_ptv_data_Victoria_240613, eval = FALSE, echo = FALSE}

ptv_240613 <- gtfstools::merge_gtfs(
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/1/google_transit.zip"),
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/2/google_transit.zip"),
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/3/google_transit.zip"),
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/4/google_transit.zip"),
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/5/google_transit.zip"),
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/6/google_transit.zip"),
#  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/7/google_transit.zip"),
#  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/8/google_transit.zip"),
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/10/google_transit.zip"),
  gtfstools::read_gtfs("~/gtfssupplyindex_melbounre_LGA_2024/data/ptv_240613/gtfs/11/google_transit.zip")
)


gtfstools::remove_duplicates(ptv_240613)

gtfstools::write_gtfs(ptv_240613,"data/ptv_240613/gtfs_merged.zip")

#Delete multiple enteries in agency txt file
ptv_240613 <- gtfstools::read_gtfs("data/ptv_240613/gtfs_merged_edited.zip")
gtfstools::remove_duplicates(ptv_240613)
#gtfstools::write_gtfs(ptv_240613,"data/ptv_240613/gtfs_merged_edited_duplcates_removed.zip")

ptv_240613_tidygtfs <- ptv_240613 %>% as_tidygtfs()

# Warning message:
#In gtfs_to_tidygtfs(x) :
#  Duplicated ids found in: agency, calendar, calendar_dates, stops
#The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue.

ptv_240613_tidygtfs$agency <- ptv_240613_tidygtfs$agency[1,]
ptv_240613_tidygtfs$calendar <- ptv_240613_tidygtfs$calendar %>% distinct(service_id, .keep_all = TRUE)
ptv_240613_tidygtfs$calendar_dates <- ptv_240613_tidygtfs$calendar_dates %>% distinct(service_id, .keep_all = TRUE)
ptv_240613_tidygtfs$stops <- ptv_240613_tidygtfs$stops %>% distinct(stop_id, .keep_all = TRUE)
ptv_240613_tidygtfs <- ptv_240613_tidygtfs %>% as_tidygtfs()

tidytransit::write_gtfs(ptv_240613_tidygtfs, "data/ptv_240613/tidygtfs.zip")

ptv_240613_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_240613/tidygtfs.zip")
                                                        


```


```{r fix_ptv_data_Victoria_210805, eval = FALSE, echo = FALSE}

ptv_210805 <- tidytransit::read_gtfs("data/ptv_210805/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_210805_duplicated_stops <- tabyl(ptv_210805$stops$stop_id) %>% filter (n>1)
names(ptv_210805_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_210805_duplicated_stops <- left_join(ptv_210805_duplicated_stops, ptv_210805$stops)

##discard duplicates
ptv_210805$stops <- ptv_210805$stops[!duplicated(ptv_210805$stops$stop_id),]

## Write gtfs back to file
ptv_210805 <- as_tidygtfs(ptv_210805)
tidytransit::write_gtfs(ptv_210805, "data/ptv_210805/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")


```

```{r fix_ptv_data_Victoria_160804, eval = FALSE, echo = FALSE}
 

ptv_160804 <- tidytransit::read_gtfs("data/ptv_160804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_160804_duplicated_stops <- tabyl(ptv_160804$stops$stop_id) %>% filter (n>1)
names(ptv_160804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_160804_duplicated_stops <- left_join(ptv_160804_duplicated_stops, ptv_160804$stops)

##discard duplicates
ptv_160804$stops <- ptv_160804$stops[!duplicated(ptv_160804$stops$stop_id),]

## Write gtfs back to file
ptv_160804 <- as_tidygtfs(ptv_160804)
tidytransit::write_gtfs(ptv_160804, "data/ptv_160804/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_160809_CCD2006, eval = FALSE, echo = FALSE}

## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs


asgc2006 <- st_read("data/asgc2006.gpkg", layer = "census_collection_district_2006")
st_geometry(asgc2006) <- "geometry"

melbourne <- asgc2006 %>% 
  filter(MSR_NAME_2006 == "Melbourne") %>%
  select(CD_CODE_2006)

#Load Greater Melbourne CCD codes
areas_of_interest <- load_areas_of_interest(melbourne,  
  area_id_field = "CD_CODE_2006")


stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)



si_CCD2006_16_census_week <- SI_by_day_hour_and_route_type(
     list_gtfs = list_gtfs, 
stops_in_or_near_areas = stops_in_or_near_areas,
 start_date_ymd = "2016-08-09", 
 end_date_ymd = "2016-08-15",
verbose = TRUE)

write.csv(si_CCD2006_16_census_week, "results/Greater_Melbourne/si_CCD2006_16_census_week")


si_CCD2006_16_census_week_aggregated <- si_CCD2006_16_census_week %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

write.csv(si_CCD2006_16_census_week_aggregated, "results/Greater_Melbourne/si_CCD2006_16_census_week_aggregated.csv")


```

```{r run_for_all_modes_Victoria_210810_CCD, eval = FALSE, echo = FALSE}
list_gtfs = ptv_210805_list_gtfs

#ccd_vic_2006 <- st_read("data/1259030002_cd06avic_shape/CD06aVIC.shp")

asgc2006 <- st_read("data/asgc2006.gpkg", layer = "census_collection_district_2006")
st_geometry(asgc2006) <- "geometry"

melbourne <- asgc2006 %>% 
  filter(MSR_NAME_2006 == "Melbourne") %>%
  select(CD_CODE_2006)

#Load Greater Melbourne CCD codes
areas_of_interest <- load_areas_of_interest(melbourne,  
  area_id_field = "CD_CODE_2006")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_CCD2006_21_census_week <- SI_by_day_hour_and_route_type(
     list_gtfs = list_gtfs, 
stops_in_or_near_areas = stops_in_or_near_areas,
 start_date_ymd = "2021-08-10", 
 end_date_ymd = "2021-08-16",
verbose = TRUE)

write.csv(si_CCD2006_21_census_week, "results/Greater_Melbourne/si_CCD2006_21_census_week.csv")

si_CCD2006_21_census_week <- read_csv("results/Greater_Melbourne/si_CCD2006_21_census_week.csv")

si_CCD2006_21_census_week_aggregated <- si_CCD2006_21_census_week %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

write.csv(si_CCD2006_21_census_week_aggregated, "results/Greater_Melbourne/si_CCD2006_21_census_week_aggregated.csv")

## Add areas north east of Warburton 2190709 and 2190710 ?
## remove water area around French Island (Western Port) this is CCD 2341923. 

```


```{r run_for_all_modes_Greater_Melbourne_240810_SA1, eval = FALSE, echo = FALSE}
list_gtfs = ptv_240613_list_gtfs

areas_of_interest <- load_areas_of_interest(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>%
    select(sa1_code_2021),  
  area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_SA12021_24_census_week <- SI_by_day_hour_and_route_type(
     list_gtfs = list_gtfs, 
stops_in_or_near_areas = stops_in_or_near_areas,
 start_date_ymd = "2021-08-06", 
 end_date_ymd = "2021-08-12",
verbose = TRUE)

write.csv(si_SA12021_24_census_week, "results/Greater_Melbourne/si_SA12021_24_census_week.csv")

si_SA12021_24_census_week <- read_csv("results/Greater_Melbourne/si_SA12021_24_census_week.csv")

si_SA12021_24_census_week_aggregated <- si_SA12021_24_census_week %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

write.csv(si_SA12021_24_census_week_aggregated, "results/si_SA12021_24_census_week_aggregated.csv")


```



```{r run_for_all_modes_Greater_Melbourne_210810_SA1, eval = FALSE, echo = FALSE}
list_gtfs = ptv_210805_list_gtfs

areas_of_interest <- load_areas_of_interest(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>%
    select(sa1_code_2021),  
  area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_SA12021_21_census_week <- SI_by_day_hour_and_route_type(
     list_gtfs = list_gtfs, 
stops_in_or_near_areas = stops_in_or_near_areas,
 start_date_ymd = "2021-08-10", 
 end_date_ymd = "2021-08-16",
verbose = TRUE)

write.csv(si_SA12021_21_census_week, "results/Greater_Melbourne/si_SA12021_21_census_week.csv")

si_SA12021_21_census_week <- read_csv("results/Greater_Melbourne/si_SA12021_21_census_week.csv")

si_SA12021_21_census_week_aggregated <- si_SA12021_21_census_week %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

write.csv(si_SA12021_21_census_week_aggregated, "results/si_SA12021_21_census_week_aggregated.csv")


```

```{r run_for_all_modes_Victoria_160809_SA12021, eval = FALSE, echo = FALSE}

## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")


list_gtfs = ptv_160804_list_gtfs

areas_of_interest <- load_areas_of_interest(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>%
    select(sa1_code_2021),  
  area_id_field = "sa1_code_2021")

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)



si_SA12021_16_census_week <- SI_by_day_hour_and_route_type(
     list_gtfs = list_gtfs, 
stops_in_or_near_areas = stops_in_or_near_areas,
 start_date_ymd = "2016-08-09", 
 end_date_ymd = "2016-08-15",
verbose = TRUE)

write.csv(si_SA12021_16_census_week, "results/Greater_Melbourne/si_SA12021_16_census_week")


si_SA12021_16_census_week_aggregated <- si_SA12021_16_census_week %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

write.csv(si_SA12021_16_census_week_aggregated, "results/Greater_Melbourne/si_SA12021_16_census_week_aggregated.csv")


```

```{r run_for_all_modes_Victoria_160809_2016SA1s, eval = FALSE, echo = FALSE}
list_gtfs = ptv_160804_list_gtfs

areas_of_interest <- load_areas_of_interest(
  absmapsdata::sa12016 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>%
    select(sa1_code_2021),  
  area_id_field = "sa1_code_2021")

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)



si_SA12016_16_census_week <- SI_by_day_hour_and_route_type(
     list_gtfs = list_gtfs, 
stops_in_or_near_areas = stops_in_or_near_areas,
 start_date_ymd = "2016-08-09", 
 end_date_ymd = "2016-08-15",
verbose = TRUE)

write.csv(si_SA12016_16_census_week, "results/Greater_Melbourne/si_SA12016_16_census_week")


si_SA12016_16_census_week_aggregated <- si_SA12016_16_census_week %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

write.csv(si_SA12016_16_census_week_aggregated, "results/Greater_Melbourne/si_SA12016_16_census_week_aggregated.csv")


```

```{r read_ABS_data_2021, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="SI scores by SA3, census day 2016 and 2021"}

#read IRSAD 2021 and remove non-data rows
sa1_irsad_2021 <- read_excel("data/Statistical Area Level 1, Indexes, SEIFA 2021.xlsx", 
    sheet = "Table 3", skip = 5)
sa1_irsad_2021 <- sa1_irsad_2021 %>% filter(row_number() <= n()-3)
sa1_irsad_2021 <- sa1_irsad_2021 %>% 
  clean_names()

#read students 2021 and remove non-data rows
sa1_students_2021 <- read_csv("data/sa1_students.csv", 
    skip = 8)
sa1_students_2021 <- sa1_students_2021[-1,]
sa1_students_2021 <- sa1_students_2021 %>% filter(row_number() <= n()-5)

#read not in labour force in 2021 and remove non-data rows
#this dataset contains a single 'wafer', 
# being those people not in the labour force, separated by age and sa1
sa1_not_in_labour_force_2021 <- read_csv("data/sa1_not_in_labour_force_2021.csv", 
    skip = 10)
sa1_not_in_labour_force_2021 <- sa1_not_in_labour_force_2021[-1,]
#not_in_labour_force csv from ABS repeats the entire dataset, hence only read in first set
sa1_not_in_labour_force_2021 <- sa1_not_in_labour_force_2021 %>% filter(row_number() <= n()-61844)


#calculate number of adults not in labour force (ie 18+)
sa1_not_in_labour_force_2021$adult_not_labour_force <- rowSums (sa1_not_in_labour_force_2021[,20:117])
  

#read no car in 2021 and remove non-data rows
#this dataset contains a single 'wafer', 
# being those people living in a household with no car, separated by age and sa1
sa1_no_car_2021 <- read_csv("data/sa1_no_car_2021.csv", 
    skip = 8)
sa1_no_car_2021 <- sa1_no_car_2021[-1,]
sa1_no_car_2021 <- sa1_no_car_2021 %>% filter(row_number() <= n()-5)
#calculate number of adults with no car (ie 18+)
sa1_no_car_2021$adult_no_car <- rowSums(sa1_no_car_2021[,20:117])


#read low income in 2021 and remove non-data rows
sa1_low_income_2021 <- read_csv("data/sa1_low_income.csv", 
    skip = 8)
sa1_low_income_2021 <- sa1_low_income_2021[-1,]
sa1_low_income_2021 <- sa1_low_income_2021 %>% filter(row_number() <= n()-5)

#read disability support pension in 2021 and remove non-data rows
sa1_disability_support_pension_2021 <- read_csv("data/sa1_disability_2021.csv", 
    skip = 8)
sa1_disability_support_pension_2021 <- sa1_disability_support_pension_2021[-1,]
sa1_disability_support_pension_2021 <- sa1_disability_support_pension_2021 %>% filter(row_number() <= n()-5)


#read age in 2021 and remove non-data rows
sa1_age_2021 <- read_csv("data/sa1_age.csv", 
    skip = 8)
sa1_age_2021 <- sa1_age_2021[-1,]
sa1_age_2021 <- sa1_age_2021 %>% filter(row_number() <= n()-5)

#calculate number of people over 60.
sa1_age_2021$over_60 <- rowSums(sa1_age_2021[,63:117])

#calculate number of persons 5 to 9 years old.
sa1_age_2021$persons_5_to_9 <- rowSums(sa1_age_2021[,7:11]) 
#move age-related indicators into social indicators table. 
social_2021_sa1 <- sa1_age_2021 %>% 
  select(`AGEP Age`, over_60, persons_5_to_9)
names(social_2021_sa1) <- c("sa1_code_2021", "over_60", "five_to_nine")

#join Adults without Cars
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_no_car_2021 %>% 
                               select("AGEP Age", "adult_no_car"), 
                             by = join_by( "sa1_code_2021" == "AGEP Age"))

#join disability pension 
sa1_disability_support_pension_2021 <-  sa1_disability_support_pension_2021 %>% 
  clean_names()
  
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_disability_support_pension_2021 %>% 
                               select(
                                 "igap_main_type_of_personal_government_benefit_payment_administrative_data", 
                                      "disability_support_pension"),
                             by = join_by(
                               "sa1_code_2021" == "igap_main_type_of_personal_government_benefit_payment_administrative_data"))



#join low income households
sa1_low_income_2021$low_income_families <- rowSums(sa1_low_income_2021[,2:9])
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_low_income_2021 %>% 
                               select("FINASF Total Family Income as Stated (weekly)", "low_income_families"), 
                             by = join_by( "sa1_code_2021" == "FINASF Total Family Income as Stated (weekly)"))


#join adults not in labour force
social_2021_sa1 <- full_join(social_2021_sa1 %>% na.omit(), 
                             sa1_not_in_labour_force_2021 %>% 
                               select("AGEP Age", "adult_not_labour_force") %>%
                               na.omit(), 
                             by = join_by("sa1_code_2021" == "AGEP Age"))

#join students
sa1_students_2021$students <- sa1_students_2021$Total
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_students_2021 %>% 
                               select("STUP Full-Time/Part-Time Student Status", "students"), 
                             by = join_by( "sa1_code_2021" == "STUP Full-Time/Part-Time Student Status"))

#join IRSAD scores
sa1_irsad_2021$x2021_statistical_area_level_1_sa1 <- sa1_irsad_2021$x2021_statistical_area_level_1_sa1 %>% 
  as.character()
names(sa1_irsad_2021) <- c("sa1_code_2021", 
                           "usual_resident_population",
                           "IRSAD", 
                           "x4", 
                           "rank_in_australia", 
                           "decile_in_australia",
                           "percentile_in_australia", 
                           "x8", 
                           "state", 
                           "rank_in_state",
                           "decile_in_state",
                           "percentile_in_state")

social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_irsad_2021 %>% 
                               select("sa1_code_2021", "IRSAD"))


#join SA1 enumerated population
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_age_2021 %>% 
                               select("AGEP Age", "Total"), 
                             by = join_by("sa1_code_2021" == "AGEP Age"))

names(social_2021_sa1) <- c("sa1_code_2021", 
                            "over_60", "age_five_to_nine", 
                            "adult_no_car", 
                            "disability_support_pension",
                            "low_income_families",
                            "adult_not_labour_force",
                            "students", 
                            "IRSAD", 
                            "population")

##Rescaling to 0-100 and adding the accessibility indicator needs to be done on a areas_of_interest by areas_of_interest bias, as which areas are included will matter. 

```

```{r read_ABS_data_2016, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="SI scores by SA3, census day 2016 and 2021"}

#read IRSAD 2016 and remove non-data rows
sa1_irsad_2016 <- read_excel("data/2033055001 - sa1 indexes.xls", 
    sheet = "Table 3", skip = 4)
names(sa1_irsad_2016) <- c("sa1_code_2016", 
                           "sa1_code_2016_11_digit", 
                           "usual_resident_population", 
                           "IRSAD",
                           "x4",
                           "rank_in_australia",
                           "decile_in_australia",
                           "percentile_in_australia",
                           "x8",
                           "state", 
                           "rank_in_state", 
                           "decile_in_state", 
                           "percentile_in_state")

sa1_irsad_2016 <- sa1_irsad_2016[-1,]
sa1_irsad_2016 <- sa1_irsad_2016 %>% filter(row_number() <= n()-2)

#read students 2016 and remove non-data rows
sa1_students_2016 <- read_csv("data/sa1_students_ur_2016.csv", 
    skip = 8)
sa1_students_2016 <- sa1_students_2016[-1,]
sa1_students_2016 <- sa1_students_2016 %>% filter(row_number() <= n()-5)

#read not in labour force in 2016 and remove non-data rows
#this dataset contains a single 'wafer', 
# being those people not in the labour force, separated by age and sa1
sa1_not_in_labour_force_2016 <- read_csv("data/sa1_not_in_labour_force_2016.csv", 
    skip = 10)
sa1_not_in_labour_force_2016 <- sa1_not_in_labour_force_2016[-1,]
#not_in_labour_force csv from ABS repeats the entire dataset, hence only read in first set
sa1_not_in_labour_force_2016 <- sa1_not_in_labour_force_2016 %>% filter(row_number() <= n()-5)


#calculate number of adults not in labour force (ie 18+)
sa1_not_in_labour_force_2016$adult_not_labour_force <- rowSums (sa1_not_in_labour_force_2016[,20:117])
  



#read no car in 2016 and remove non-data rows
#this dataset contains a single 'wafer', 
# being those people living in a household with no car, separated by age and sa1
sa1_no_car_2016 <- read_csv("data/sa1_no_vehices_2016.csv", 
    skip = 8)
sa1_no_car_2016 <- sa1_no_car_2016[-1,]
sa1_no_car_2016 <- sa1_no_car_2016 %>% filter(row_number() <= n()-5)
#calculate number of adults with no car (ie 18+)
sa1_no_car_2016$adult_no_car <- rowSums(sa1_no_car_2016[,20:117])


#read low income in 2016 and remove non-data rows
sa1_low_income_2016 <- read_csv("data/sa1_family_income_2016.csv", 
    skip = 8)
sa1_low_income_2016 <- sa1_low_income_2016[-1,]
sa1_low_income_2016 <- sa1_low_income_2016 %>% filter(row_number() <= n()-5)

#read disability support pension DISABILITY SUPPORT PENSION DATA NOT REPORTED IN 2016



#read age in 2016 and remove non-data rows
sa1_age_2016 <- read_csv("data/sa1_ur_agep_2016.csv", 
    skip = 8)
sa1_age_2016 <- sa1_age_2016[-1,]
sa1_age_2016 <- sa1_age_2016 %>% filter(row_number() <= n()-5)

#calculate number of people over 60.
sa1_age_2016$over_60 <- rowSums(sa1_age_2016[,63:117])

#calculate number of persons 5 to 9 years old.
sa1_age_2016$age_five_to_nine <- rowSums(sa1_age_2016[,7:11]) 


## create social indiators table
social_2016_sa1 <- sa1_irsad_2016 %>% 
  select(sa1_code_2016, 
         sa1_code_2016_11_digit,
         usual_resident_population,
         IRSAD)

social_2016_sa1$sa1_code_2016 <- social_2016_sa1$sa1_code_2016 %>% as.character()
social_2016_sa1$sa1_code_2016_11_digit <- social_2016_sa1$sa1_code_2016_11_digit %>% as.character()

#move age-related indicators into social indicators table. 
social_2016_sa1 <- left_join(
  social_2016_sa1,
  sa1_age_2016 %>% 
  select(`AGEP Age`, over_60, age_five_to_nine),
by = join_by( "sa1_code_2016" == "AGEP Age")
)


#join Adults without Cars
social_2016_sa1 <- full_join(social_2016_sa1, 
                             sa1_no_car_2016 %>% 
                               select("AGEP Age", "adult_no_car"), 
                             by = join_by( "sa1_code_2016" == "AGEP Age"))

#join disability pension NOT PRESENT IN THE DATA


#join low income households
sa1_low_income_2016$low_income_families <- rowSums(sa1_low_income_2016[,2:9])
social_2016_sa1 <- full_join(social_2016_sa1, 
                             sa1_low_income_2016 %>% 
                               select("FINASF Total Family Income as Stated (weekly)", "low_income_families"), 
                             by = join_by( "sa1_code_2016" == "FINASF Total Family Income as Stated (weekly)"))


#join adults not in labour force
social_2016_sa1 <- full_join(social_2016_sa1 %>% na.omit(), 
                             sa1_not_in_labour_force_2016 %>% 
                               select("AGEP Age", "adult_not_labour_force") %>%
                               na.omit(), 
                             by = join_by("sa1_code_2016" == "AGEP Age"))

#join students
sa1_students_2016$students <- sa1_students_2016$Total - sa1_students_2016$`Not attending`
social_2016_sa1 <- full_join(social_2016_sa1, 
                             sa1_students_2016 %>% 
                               select("STUP Full-Time/Part-Time Student Status", "students"), 
                             by = join_by( "sa1_code_2016" == "STUP Full-Time/Part-Time Student Status"))


#join SA1 enumerated population
social_2016_sa1 <- full_join(social_2016_sa1, 
                             sa1_age_2016 %>% 
                               select("AGEP Age", "Total"), 
                             by = join_by("sa1_code_2016" == "AGEP Age"))

social_2016_sa1 <- social_2016_sa1 %>% select(
  sa1_code_2016, 
  over_60, 
  age_five_to_nine,
  adult_no_car,
  low_income_families,
  adult_not_labour_force,
  students,
  IRSAD,
  usual_resident_population,
  sa1_code_2016_11_digit
)

names(social_2016_sa1) <- c("sa1_code_2016", 
                            "over_60", "age_five_to_nine", 
                            "adult_no_car", 
                            "low_income_families",
                            "adult_not_labour_force",
                            "students", 
                            "IRSAD", 
                            "population",
                            "sa1_code_2016_11_digit")

social_2016_sa1$IRSAD <- social_2016_sa1$IRSAD %>% as.numeric()

##Rescaling to 0-100 and adding the accessibility indicator needs to be done on a areas_of_interest by areas_of_interest bias, as which areas are included will matter. 

```

```{r Greater_Melbourne_CCD_2016, fig.show="hold", out.width="100%", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE}

## FUNCTION to define thresholds and return Very High, High etc. 
# as per Currie2010 Table 3 and page 34. 
# the approach appears to be to first identify zones that have zero supply 
# the remainder are then split into those above and below the average SI value
# these two groups are then each split into three groups of roughly equal size. 
set_thresholds <-function(si_by_area_dataframe){ 

## Define Very High, High etc thresholds
cuts_lower_groups <- si_by_area_dataframe %>% 
  st_drop_geometry() %>% 
  filter(SI !=0) %>%
  filter(SI <= SI %>% mean()) %>% 
  select(SI) %>% unlist() %>% 
  as.vector() %>% 
  quantileCut(3)

cuts_upper_groups <- si_by_area_dataframe %>% 
  st_drop_geometry() %>% 
  filter(SI !=0) %>%
  filter(SI > SI %>% mean()) %>%
  select(SI) %>% unlist() %>% 
  as.vector() %>% 
  quantileCut(3)

# Recode lower_group factors
allocation_lower_groups <- cuts_lower_groups %>% fct_recode(
  "Very Low" = levels(cuts_lower_groups)[1], 
  "Low" = levels(cuts_lower_groups)[2], 
  "Below average" = levels(cuts_lower_groups)[3])

# Recode upper_group factors
allocation_upper_groups <- cuts_upper_groups %>% fct_recode(
  "Above average" = levels(cuts_upper_groups)[1], 
  "High" = levels(cuts_upper_groups)[2], 
  "Very High" = levels(cuts_upper_groups)[3])


# Join back to lower_group SIs and areas_of_interest
si_by_area_dataframe_below_average <- si_by_area_dataframe %>% 
  st_drop_geometry() %>% 
  filter(SI !=0) %>%
  filter(SI <= SI %>% mean()) 
si_by_area_dataframe_below_average$transit_supply <- allocation_lower_groups

# Join back to upper_group SIs and areas_of_interest
si_by_area_dataframe_above_average <- si_by_area_dataframe %>% 
  st_drop_geometry() %>% 
  filter(SI !=0) %>%
  filter(SI > SI %>% mean()) 
si_by_area_dataframe_above_average$transit_supply <- allocation_upper_groups

# combine upper and lower groups
  
si_by_area_dataframe_non_zero <- add_row(si_by_area_dataframe_below_average, 
                                         si_by_area_dataframe_above_average)

#join back to dataframe, and put "Zero" in N/A
si_by_area_dataframe <- full_join(
  si_by_area_dataframe %>% 
    st_drop_geometry(), 
  si_by_area_dataframe_non_zero
)

si_by_area_dataframe$transit_supply <- si_by_area_dataframe$transit_supply %>% 
  fct_explicit_na(na_level = "Zero Supply") %>% 
  fct_shift(n = -1)

#return dataframe and information about level cut offs
si_by_area_dataframe_and_cuts_dataframe <- list(
  si_by_area_dataframe,
  c(levels(cuts_lower_groups), levels(cuts_upper_groups))
  )
return(si_by_area_dataframe_and_cuts_dataframe)
}
# END FUNCTION

## FUNCTION to set thresholds and return tibble, plot output and thresholds
si_thresholds_and_plot_function <- function(si_by_area, areas_of_interest){
# Set column names
names(si_by_area) <- c("area_id", "SI")
names(areas_of_interest) <- c("area_id", "geometry")
  
si_by_area$area_id <- si_by_area$area_id %>% 
  as.character()


##Join to areas_of_interest so as to identify (and enumerate as zero) 
# those areas of interest that have no SI score 

si_by_area <- full_join(
  areas_of_interest,
  si_by_area)
si_by_area[is.na(si_by_area)] <- 0

si_by_area_thresholds <- set_thresholds(si_by_area_dataframe = si_by_area)
si_by_area <- si_by_area_thresholds[[1]]


si_by_area <- left_join(
  areas_of_interest, 
  si_by_area)

output_plot <- ggplot()+ 
  geom_sf(data=si_by_area %>% na.omit(),
          aes(fill = transit_supply), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none",
#        legend.text = element_text(size = 4), 
#        legend.title = element_text(size = 5), 
#        legend.key.size = unit(0.08, 'cm')
        ) + 
  scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) 


  outputs <- list("si_by_area" = si_by_area, 
                  "output_plot" = output_plot, 
                  "thresholds" = si_by_area_thresholds[[2]])
  return(outputs)
}

### Load 2016 CCD results
si_by_area <- read.csv("results/Greater_Melbourne/si_CCD2006_16_census_week_aggregated.csv") %>% 
  as_tibble()
si_by_area <- si_by_area[,2:3]
#Remove Western Port CCD 
si_by_area <- si_by_area %>% filter(area_id != 2341923)
asgc2006 <- st_read("data/asgc2006.gpkg", layer = "census_collection_district_2006", quiet = TRUE)
st_geometry(asgc2006) <- "geometry"

melbourne_CCD <- asgc2006 %>% 
  filter(MSR_NAME_2006 == "Melbourne") %>% 
  filter(CD_CODE_2006 != "2341923") %>% #Remove Western Port water area
  select(CD_CODE_2006)
areas_of_interest <- melbourne_CCD

si_CCD2006_16_census_week_aggregated <- si_thresholds_and_plot_function(si_by_area, areas_of_interest)

# Load 2006 Melbourne boundary
melbourne_sd07aust_region <- st_read("data/1259030001sd07 aust/", quiet = TRUE) %>% 
  filter(SDNAME07 == "Melbourne")

# Load 2006 LGA boundaries
vic_lga07aust_region <- st_read("data/1259030001lga07 aust/", quiet = TRUE) %>% 
                                  filter(STATE07 == 2)

# Set boundaries between around middle suburbs       
middle_lga07aust_region <- vic_lga07aust_region[
  vic_lga07aust_region$LGANAME07 %in% 
    c("Banyule (C)", "Bayside (C)", "Boroondara (C)", "Brimbank (C)", 
      "Darebin (C)", "Glen Eira (C)", "Greater Dandenong (C)", 
      "Hobsons Bay (C)", "Kingston (C)", "Manningham (C)", 
      "Maribyrnong (C)", "Monash (C)", "Moonee Valley (C)", 
      "Moreland (C)", "Stonnington (C)","Whitehorse (C)"), ] 
middle_lga07aust_region <- st_union(middle_lga07aust_region)



### Load 2016 railway locations
# convert to list of tidygtfs objects
#ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

#melbourne_railway_trips_shape_2016 <- ptv_160804_list_gtfs [[2]] %>% 
# tidytransit::gtfs_as_sf() %>%
#  tidytransit::get_route_geometry(route_ids = c("2-WMN-N-mjp-1", "2-WBE-O-mjp-1", "2-UFD-I-mjp-1", "2-SYM-F-mjp-1", "2-SPT-G-mjp-1", "2-SDM-G-mjp-1", "2-PKM-D-mjp-1", "2-CRB-E-mjp-1", "2-MER-F-mjp-1", "2-LIL-G-mjp-1", "2-HBG-F-mjp-1", "2-GLW-G-mjp-1", "2-FKN-N-mjp-1", "2-ain-D-mjp-1", "2-B31-G-mjp-1", "2-BEL-G-mjp-1", "2-ALM-F-mjp-1", "2-WBE-E-mjp-1", "2-WMN-E-mjp-1",  "2-UFD-B-mjp-1",  "2-EPP-B-mjp-1", "2-SDM-C-mjp-1", "2-LIL-C-mjp-1", "2-GLW-D-mjp-1", "2-FKN-D-mjp-1", "2-BEL-D-mjp-1", "2-ALM-C-mjp-1", "2-B31-E-mjp-1"))


#st_write(melbourne_railway_trips_shape_2016, "results/melbourne_railway_trips_shape_2016.shp", append = FALSE)

melbourne_railway_trips_shape_2016 <- st_read("results/melbourne_railway_trips_shape_2016.shp", quiet = TRUE)




### Load 2021 railway locations
# convert to list of tidygtfs objects
#ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

#melbourne_railway_trips_shape <- ptv_210805_list_gtfs [[2]] %>% 
# tidytransit::gtfs_as_sf() %>%
#  tidytransit::get_route_geometry(route_ids = c("2-WMN-N-mjp-1", "2-WBE-O-mjp-1", "2-UFD-I-mjp-1", "2-SYM-F-mjp-1", "2-SPT-G-mjp-1", "2-SDM-G-mjp-1", "2-PKM-D-mjp-1", "2-CRB-E-mjp-1", "2-MER-F-mjp-1", "2-LIL-G-mjp-1", "2-HBG-F-mjp-1", "2-GLW-G-mjp-1", "2-FKN-N-mjp-1", "2-ain-D-mjp-1", "2-B31-G-mjp-1", "2-BEL-G-mjp-1", "2-ALM-F-mjp-1", "2-WBE-E-mjp-1"))

#st_write(melbourne_railway_trips_shape, "results/melbourne_railway_trips_shape.shp", append = FALSE)

melbourne_railway_trips_shape_2021 <- st_read("results/melbourne_railway_trips_shape.shp", quiet = TRUE)


# plot with Inner South, middle and outer boundaries
si_CCD2006_16_plot <- si_CCD2006_16_census_week_aggregated$output_plot + 
  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.25, colour = "blue") +
  geom_sf(data=melbourne_railway_trips_shape_2016, linetype = "twodash", size = 0.1) 
 

```



```{r Greater_Melbourne_CCD_2021, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.dim = c(7.5,7.5), fig.cap="Melbourne (2006 extents), Transport Supply by CCD, week starting the day of the 2016 (top) and 2021 (bottom) censuses, overlayed with inner/middle/outer suburban boundary (blue) and suburban railway lines (black)"}

si_by_area <- read.csv("results/Greater_Melbourne/si_CCD2006_21_census_week_aggregated.csv") %>% 
  as_tibble()
si_by_area <- si_by_area[,2:3]
#Remove Western Port CCD 
si_by_area <- si_by_area %>% filter(area_id != 2341923)
asgc2006 <- st_read("data/asgc2006.gpkg", layer = "census_collection_district_2006", quiet = TRUE)
st_geometry(asgc2006) <- "geometry"

areas_of_interest <- melbourne_CCD

si_CCD2006_21_census_week_aggregated <- si_thresholds_and_plot_function(si_by_area, areas_of_interest)


# plot with inner, middle and outer boundaries
si_CCD2006_21_plot <- si_CCD2006_21_census_week_aggregated$output_plot + 
  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.25, colour = "blue") +
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1)  + 
  ggspatial::annotation_scale(location = 'br') + 
  ggspatial::annotation_north_arrow() 


# join into one 
si_CCD2006_16_census_week_aggregated$si_by_area$Year <- 2016
si_CCD2006_21_census_week_aggregated$si_by_area$Year <- 2021

si_by_area_CCD2006_2016_2021 <- add_row(
  si_CCD2006_16_census_week_aggregated$si_by_area, 
  si_CCD2006_21_census_week_aggregated$si_by_area %>% 
    select(area_id, SI, transit_supply, geometry, Year)
)

#plot_CCD2006_2016_2021_comparison <- ggplot()+ 
#  geom_sf(data=si_by_area_CCD2006_2016_2021 %>% na.omit(),
#          aes(fill = transit_supply), colour=NA) +
#  facet_wrap(vars(Year), nrow = 1) +
#  theme(axis.text.x=element_blank(), #remove x axis labels
#        axis.ticks.x=element_blank(), #remove x axis ticks
#        axis.text.y=element_blank(),  #remove y axis labels
#        axis.ticks.y=element_blank(), #remove y axis ticks
#        legend.position="bottom") + 
#  scale_fill_manual(values = c("#FFFFFF", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
#  geom_sf(data=melbourne_railway_trips_shape, linetype = "twodash", size = 0.1) 



# plot_CCD2006_2016_2021_comparison + 
#    geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
# ggspatial::annotation_scale(location = 'br') + 
# ggspatial::annotation_north_arrow() 
 
```

```{r Greater_Melbourne_CCD_2021_rail_extents, fig.show="hold", out.width="100%", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, eval = FALSE, fig.cap="Melbourne, extent of suburban rail network (except Stony Point line)), Transport Supply by CCD, week starting the day of the 2016 (left) and 2021 (right) censuses, overlayed with inner/middle/outer suburban boundary (blue) and suburban railway lines (black)"}
 
# generate plot to extents of rail suburban rail network only
si_CCD2006_16_plot +
  coord_sf(ylim = c(-37.590, -38.153), 
           xlim = c(144.670, 145.471)) /
si_CCD2006_21_census_week_aggregated$output_plot + 
  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.25) +
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1) +
  coord_sf(ylim = c(-37.590, -38.153), 
           xlim = c(144.670, 145.471)) + 
  ggspatial::annotation_scale(location = 'br') + 
  ggspatial::annotation_north_arrow()


```

```{r Greater_Melbourne_2021_SA1_plot, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.dim = c(7.5,7.5), fig.cap="Greater Melbourne, Transport Supply by SA1 for the week starting the date of the 2021 census, overlayed with: 2006 Greater Melbourne boundary (black); 2021 SA4 boundaries (blue); and suburban railway lines (black)"}


#obtain SA4 boundaries
sa4_boundaries <- absmapsdata::sa42021 %>% filter(gcc_name_2021 == "Greater Melbourne")



## 2016 SA12016 Greater Melbourne
si_by_area <-  read.csv( "results/Greater_Melbourne/si_SA12016_16_census_week_aggregated.csv") %>% 
  as_tibble()
si_by_area <- si_by_area[,2:3]

areas_of_interest <-  absmapsdata::sa12016 %>% 
    filter(gcc_name_2016 == "Greater Melbourne") %>% 
    select(sa1_code_2016)

melbourne_si_SA12016_16_census_week_aggregated <- si_thresholds_and_plot_function(si_by_area, areas_of_interest)

melbourne_si_SA12016_16_plot <- melbourne_si_SA12016_16_census_week_aggregated$output_plot + 
  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
  geom_sf(data=melbourne_sd07aust_region, 
          colour="black", 
          fill=NA) +
  geom_sf(data=melbourne_railway_trips_shape_2016, linetype = "twodash", size = 0.1) 




## SA12021 2016 Greater Melbourne
si_by_area <-  read.csv( "results/Greater_Melbourne/si_SA12021_16_census_week_aggregated.csv") %>% 
  as_tibble()
si_by_area <- si_by_area[,2:3]

areas_of_interest <-  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021)

melbourne_si_SA12021_16_census_week_aggregated <- si_thresholds_and_plot_function(si_by_area, areas_of_interest)




## 2021 SA12021 Greater Melbourne
si_by_area <-  read.csv( "results/Greater_Melbourne/si_SA12021_21_census_week_aggregated.csv") %>% 
  as_tibble()
si_by_area <- si_by_area[,2:3]

areas_of_interest <-  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021)

melbourne_si_SA12021_21_census_week_aggregated <- si_thresholds_and_plot_function(si_by_area, areas_of_interest)


melbourne_si_SA12021_21_plot <- melbourne_si_SA12021_21_census_week_aggregated$output_plot + 
  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
  geom_sf(data=melbourne_sd07aust_region, 
          colour="black", 
          fill=NA) +
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1) 


## 2024 SA12021 Greater Melbourne
si_by_area <-  read.csv( "results/Greater_Melbourne/si_SA12021_24_census_week_aggregated.csv") %>% 
  as_tibble()
si_by_area <- si_by_area[,2:3]

areas_of_interest <-  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021)

melbourne_si_SA12021_24_census_week_aggregated <- si_thresholds_and_plot_function(si_by_area, areas_of_interest)


melbourne_si_SA12021_24_plot <- melbourne_si_SA12021_24_census_week_aggregated$output_plot + 
  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
  geom_sf(data=melbourne_sd07aust_region, 
          colour="black", 
          fill=NA) +
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1) 





melbourne_si_SA12021_16_census_week_aggregated$si_by_area$Year <- 2016

melbourne_si_SA12021_21_census_week_aggregated$si_by_area$Year <- 2021


melbourne_si_SA12021_24_census_week_aggregated$si_by_area$Year <- 2024



si_by_area_2021_2024 <- add_row(
  melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>% 
    st_drop_geometry(), 
  melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>% 
    st_drop_geometry())
names(si_by_area_2021_2024) <- c("sa1_code_2021", "SI", "transit_supply", "Year")

si_by_area_2021_2024  <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021),
  si_by_area_2021_2024)

plot_2016_2021_comparison <- ggplot()+ 
  geom_sf(data=si_by_area_2021_2024 %>% na.omit(),
          aes(fill = transit_supply), colour=NA) +
  facet_wrap(vars(Year), nrow = 1) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none") + 
  scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) 


# plot_2016_2021_comparison + 
#  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
#  geom_sf(data=melbourne_sd07aust_region, 
#          colour="black", 
#          fill=NA) +
#  geom_sf(data=sa4_boundaries, fill = NA, colour="grey") +
# ggspatial::annotation_scale(location = 'br') + 
# ggspatial::annotation_north_arrow()


  


```


```{r Greater_Melbourne_CCDs_SA1_table, fig.show="hold", echo = FALSE, fig.height=8, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Distribution of 2006, 2016 and 2021 Transport Supply to 2006 CCDs. Sources: 2006 values - Currie (2010), 2016  and 2021 values - authors"}

# create comparison table
melbourne_comparison_2006_2021 <- si_CCD2006_21_census_week_aggregated$si_by_area %>% 
  st_drop_geometry() %>%
  tabyl(transit_supply) %>%
  select(transit_supply)

melbourne_comparison_2006_2021$ccds_2006 <- c(
  189, 
  1314, 
  1310,
  1294,
  608,
  535,
  589)

melbourne_comparison_2006_2021$population_2006 <- c(
  85423,
  793046,
  865330, 
  774521,
  324546,
  260411,
  263832)
  
  
melbourne_comparison_2006_2021$ccds_2016 <- 
  si_CCD2006_16_census_week_aggregated$si_by_area %>% 
  st_drop_geometry() %>% 
  select(transit_supply) %>% 
  table() %>% 
  as_tibble() %>%
  select(n) %>%
  unlist() %>%
  as.numeric()
  

melbourne_comparison_2006_2021$ccds_2021 <- 
  si_CCD2006_21_census_week_aggregated$si_by_area %>% 
  st_drop_geometry() %>% 
  select(transit_supply) %>% 
  table() %>% 
  as_tibble() %>%
  select(n) %>%
  unlist() %>%
  as.numeric()
  
names(melbourne_comparison_2006_2021) <- c(
"transit_supply",
"ccds_2006", 
"population_2006", 
"ccds_2016",
"ccds_2021")

melbourne_comparison_2006_2021$sa1s_2016 <- melbourne_si_SA12016_16_census_week_aggregated$si_by_area %>% 
  st_drop_geometry() %>% 
  select(transit_supply) %>% 
  table() %>% 
  as_tibble() %>%
  select(n) %>%
  unlist() %>%
  as.numeric()

melbourne_comparison_2006_2021$sa1s_2021 <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>% 
  st_drop_geometry() %>% 
  select(transit_supply) %>% 
  table() %>% 
  as_tibble() %>%
  select(n) %>%
  unlist() %>%
  as.numeric()

names(melbourne_comparison_2006_2021) <- c(
"transit_supply",
"ccds_2006", 
"population_2006", 
"ccds_2016",
"ccds_2021", 
"sa1s_2016",
"sa1s_2021")

#2016 population
# load and cleanup 2016 population by sa1
sa1_ur_agep_2016 <- read_csv("data/sa1_ur_agep_2016.csv", 
    skip = 8)
sa1_ur_agep_2016 <- sa1_ur_agep_2016[-1,]
sa1_ur_agep_2016 <- sa1_ur_agep_2016[1:57523,1:118] 
sa1_ur_agep_2016 <- sa1_ur_agep_2016%>% type.convert(as.is = T)
sa1_ur_agep_2016 <- sa1_ur_agep_2016 %>% clean_names()
colnames(sa1_ur_agep_2016)[colnames(sa1_ur_agep_2016) == "agep_age"] <- "sa1_7dig_2016"
#check variable types
#lapply(sa1_ur_agep_2016, class) %>% as_vector() %>% tabyl()
sa1_ur_agep_2016$sa1_7dig_2016 <- sa1_ur_agep_2016$sa1_7dig_2016 %>%
  as.character()

# Convert to 11 digit SA1 codes 
sa1_ur_agep_2016 <- right_join(absmapsdata::sa12016 %>% 
             st_drop_geometry() %>% 
             select(sa1_code_2016, sa1_7dig_2016), 
           sa1_ur_agep_2016) %>% 
  as_tibble()
    
# connect population to Transport Supply
areas_of_interest <-  absmapsdata::sa12016 %>% 
    filter(gcc_name_2016 == "Greater Melbourne") %>% 
    select(sa1_code_2016)

population_sa1_greater_melbourne_2016 <- left_join(
  areas_of_interest %>% st_drop_geometry(), 
  sa1_ur_agep_2016 %>% select(sa1_code_2016, total))

population_sa1_greater_melbourne_2016 <- left_join(
  melbourne_si_SA12016_16_census_week_aggregated$si_by_area %>% 
    st_drop_geometry() %>%
    select(area_id, transit_supply), 
  population_sa1_greater_melbourne_2016, 
  join_by(area_id == sa1_code_2016)
  )
names(population_sa1_greater_melbourne_2016) <- c("sa1_code_2016", 
                                             "transit_supply", 
                                             "population")


# add to comparison table
melbourne_comparison_2006_2021$population_2016 <- population_sa1_greater_melbourne_2016 %>% aggregate(population ~ transit_supply, sum) %>% 
  select(population) %>% 
  as_tibble() %>%
  unlist() %>%
  as.numeric()

names(melbourne_comparison_2006_2021) <- c(
"transit_supply",
"ccds_2006", 
"population_2006", 
"ccds_2021", 
"sa1s_2021", 
"population_2016")





# load and cleanup 2021 population by sa1
sa1_ur_agep_2021 <- read_csv("data/sa1_ur_agep_2021.csv", 
    skip = 8)
sa1_ur_agep_2021 <- sa1_ur_agep_2021[-1,]
sa1_ur_agep_2021 <- sa1_ur_agep_2021[1:61845,1:118] 
sa1_ur_agep_2021 <- sa1_ur_agep_2021%>% type.convert(as.is = T)
sa1_ur_agep_2021 <- sa1_ur_agep_2021 %>% clean_names()
colnames(sa1_ur_agep_2021)[colnames(sa1_ur_agep_2021) == "agep_age"] <- "sa1_code_2021"
#check variable types
#lapply(sa1_ur_agep_2021, class) %>% as_vector() %>% tabyl()

# connect population to Transport Supply
areas_of_interest <-  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021)
population_sa1_greater_melbourne_2021 <- left_join(
  areas_of_interest %>% st_drop_geometry(), 
  sa1_ur_agep_2021 %>% select(sa1_code_2021, total))

population_sa1_greater_melbourne_2021 <- left_join(
  melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>% 
    st_drop_geometry() %>%
    select(area_id, transit_supply), 
  population_sa1_greater_melbourne_2021, 
  join_by(area_id == sa1_code_2021)
  )
names(population_sa1_greater_melbourne_2021) <- c("sa1_code_2021", 
                                             "transit_supply", 
                                             "population")


# add to comparison table
melbourne_comparison_2006_2021$population_2021 <- population_sa1_greater_melbourne_2021 %>% aggregate(population ~ transit_supply, sum) %>% 
  select(population) %>% 
  as_tibble() %>%
  unlist() %>%
  as.numeric()

names(melbourne_comparison_2006_2021) <- c(
"transit_supply",
"ccds_2006", 
"population_2006", 
"ccds_2016",
"ccds_2021", 
"sa1s_2016",
"sa1s_2021", 
"population_2016",
"population_2021")


ccds_comparison <- melbourne_comparison_2006_2021 %>% 
             select(transit_supply, ccds_2006, ccds_2016, ccds_2021) %>% 
             pivot_longer(
    cols = 2:4,
    names_to = "category", 
    values_to = "counts")

ccds_comparison$category<- factor(
  ccds_comparison$category, levels = c("ccds_2006", "ccds_2016", "ccds_2021"))

ccds_comparison$transit_supply <- ccds_comparison$transit_supply %>% 
  factor(
    levels = c("Very High", 
               "High",
               "Above average", 
               "Below average", 
               "Low", 
               "Very Low",
               "Zero Supply"))


ccds_comparison$transit_supply <- ccds_comparison$transit_supply %>%
  fct_rev()

#ggbarstats(ccds_comparison,
#  x = transit_supply, 
#  y = category, 
#  counts = "counts") +
#  theme(legend.position = "bottom") +
#scale_fill_manual(values = c(
#  "darkgreen", 
#  "#53A212",
#  "lightgreen", 
#  "#F29C33", 
#  "#F7C387", 
#  "#F9D8B1", 
#  "#FFFFFF" 
#  )) 

 
```

```{r Greater_Melbourne_SA1s_bar_stats, fig.show="hold", echo = FALSE, fig.height=8, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Distribution of Transport Supply to 2006 CCDs, 2021 CCDs and 2021 SA1s, population 2006 and 2021. Sources: 2006 values - Currie (2010), 2021 values - authors"}


sa1_comparison <- melbourne_comparison_2006_2021 %>% 
             select(transit_supply, ccds_2006, sa1s_2016, sa1s_2021) %>% 
             pivot_longer(
    cols = 2:4,
    names_to = "category", 
    values_to = "counts")

sa1_comparison$category<- factor(
  sa1_comparison$category, levels = c("ccds_2006", "sa1s_2016", "sa1s_2021"))


sa1_comparison$transit_supply <- sa1_comparison$transit_supply %>% 
  factor(
    levels = c("Very High", 
               "High",
               "Above average", 
               "Below average", 
               "Low", 
               "Very Low",
               "Zero Supply"))


sa1_comparison$transit_supply <- sa1_comparison$transit_supply %>%
  fct_rev()

#ggbarstats(sa1_comparison,
#  x = transit_supply, 
#  y = category, 
#  counts = "counts") +
#  theme(legend.position = "bottom") +
#scale_fill_manual(values = c(
#  "darkgreen", 
#  "#53A212",
#  "lightgreen", 
#  "#F29C33", 
#  "#F7C387", 
#  "#F9D8B1", 
#  "#FFFFFF" 
#  )) 


```


```{r Greater_Melbourne_CCDs_SA1_population, fig.show="hold", echo = FALSE, fig.height=8, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne, Transport Supply by SA1 for the week starting the date of the 2021 census, overlayed with: 2006 Greater Melbourne boundary (black); 2021 SA4 boundaries (blue); and suburban railway lines (black)"}

 
pop_comparison <- melbourne_comparison_2006_2021 %>% 
             select(transit_supply, population_2006, population_2016, population_2021) %>% 
             pivot_longer(
    cols = 2:4,
    names_to = "category", 
    values_to = "population")

pop_comparison$category<- factor(
  pop_comparison$category, levels = c("population_2006", "population_2016", "population_2021"))

pop_comparison$transit_supply <- pop_comparison$transit_supply %>% 
  factor(
    levels = c("Very High", 
               "High",
               "Above average", 
               "Below average", 
               "Low", 
               "Very Low",
               "Zero Supply"))


pop_comparison$transit_supply <- pop_comparison$transit_supply %>%
  fct_rev()

#ggbarstats(pop_comparison,
#  x = transit_supply, 
#  y = category, 
#  counts = "population") +
#  theme(legend.position = "bottom") +
#scale_fill_manual(values = c(
#  "darkgreen", 
#  "#53A212",
#  "lightgreen", 
#  "#F29C33", 
#  "#F7C387", 
#  "#F9D8B1", 
#  "#FFFFFF" 
#  )) 


  
```


```{r Greater_Melbourne_SA1_2016_by_SA4, fig.show="hold", echo = FALSE, fig.height=8, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne 2016: Share of SA1s in each Transport Supply category for each SA4 region"}

melbourne_si_SA12016_16_census_week_aggregated$si_by_area <- left_join(
  melbourne_si_SA12016_16_census_week_aggregated$si_by_area,
  absmapsdata::sa12016 %>% 
    st_drop_geometry() %>%
    select(sa1_code_2016, sa4_name_2016),
  by = join_by(area_id == sa1_code_2016))

## Skip table as population more interesting
#melbourne_si_SA12016_16_census_week_aggregated$si_by_area %>%
#  st_drop_geometry() %>%
#  tabyl(sa4_name_2016, transit_supply) %>% 
#  adorn_totals(where = c("row", "col")) %>%
#  adorn_percentages(denominator = "row") %>% 
#  adorn_pct_formatting() %>%
#  adorn_ns() %>%
#  kable( 
#    caption = "Greater Melbourne 2016: Share of SA1s in each Transport Supply category for each SA4 region",
#      align = "lrrrrrrr")
  

melbourne_2016_transit_supply_by_SA4 <- melbourne_si_SA12016_16_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>%
  tabyl(sa4_name_2016, transit_supply) %>%
  pivot_longer(cols = 2:8,
    names_to = "transit_supply", 
    values_to = "SA1s") 

melbourne_2016_transit_supply_by_SA4$transit_supply <- factor(
  melbourne_2016_transit_supply_by_SA4$transit_supply, 
  levels = c(
    "Zero Supply",
    "Very Low",
    "Low",
    "Below average",
    "Above average",
    "High",
    "Very High")
)  


melbourne_2016_transit_supply_by_SA4$sa4_name_2016 <- if_else(
  melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Inner", "Inner", 
  if_else(
    melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Inner East", "Inner East",
    if_else(melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Inner South", "Inner South", 
            if_else(melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - North East", 
                    "North East", 
                    if_else(melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - North West", "North West",
                            if_else(melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Outer East", "Outer East", 
                                            if_else(melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - South East", "South East", 
                                                    if_else(melbourne_2016_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - West", "West", 
                                                            melbourne_2016_transit_supply_by_SA4$sa4_name_2016))))))))


melbourne_2016_transit_supply_by_SA4$sa4_name_2016 <- factor(
  melbourne_2016_transit_supply_by_SA4$sa4_name_2016,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))

melbourne_2016_transit_supply_by_SA4$sa4_name_2016 <- melbourne_2016_transit_supply_by_SA4$sa4_name_2016 %>% fct_rev()

melbourne_2016_transit_supply_by_SA4$transit_supply <- melbourne_2016_transit_supply_by_SA4$transit_supply %>% 
  factor(
    levels = c("Very High", 
               "High",
               "Above average", 
               "Below average", 
               "Low", 
               "Very Low",
               "Zero Supply"))


melbourne_2016_transit_supply_by_SA4$transit_supply <-melbourne_2016_transit_supply_by_SA4$transit_supply %>%
  fct_rev()
##Show SA1s by SA4 (not population) in Appendix,
# as this is needed for the statistically comparison.  
# Cannot statistically compare population, as not all are independent 
# People in the same SA1 are not independent of each other in this context.
#ggbarstats(melbourne_2016_transit_supply_by_SA4,
#  x = transit_supply, 
#  y = sa4_name_2016, 
#  counts = SA1s) +
#  theme(legend.position = "bottom") +
#scale_fill_manual(values = c(
#  "darkgreen", 
#  "#53A212",
#  "lightgreen", 
#  "#F29C33", 
#  "#F7C387", 
#  "#F9D8B1", 
#  "#FFFFFF" 
#  )) 




```

```{r Greater_Melbourne_SA1_2021_by_SA4, fig.show="hold", echo = FALSE, fig.height=8, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne 2021: Share of SA1s in each Transport Supply category for each SA4 region"}



melbourne_si_SA12021_21_census_week_aggregated$si_by_area <- left_join(
  melbourne_si_SA12021_21_census_week_aggregated$si_by_area,
  absmapsdata::sa12021 %>% 
    st_drop_geometry() %>%
    select(sa1_code_2021, sa4_name_2021),
  by = join_by(area_id == sa1_code_2021))


melbourne_2021_transit_supply_by_SA4 <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>%
  tabyl(sa4_name_2021, transit_supply) %>%
  pivot_longer(cols = 2:8,
    names_to = "transit_supply", 
    values_to = "SA1s") 

melbourne_2021_transit_supply_by_SA4$transit_supply <- factor(
  melbourne_2021_transit_supply_by_SA4$transit_supply, 
  levels = c(
    "Zero Supply",
    "Very Low",
    "Low",
    "Below average",
    "Above average",
    "High",
    "Very High")
)  

melbourne_2021_transit_supply_by_SA4$sa4_name_2021 <- if_else(
  melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Inner", "Inner", 
  if_else(
    melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Inner East", "Inner East",
    if_else(melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Inner South", "Inner South", 
            if_else(melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - North East", 
                    "North East", 
                    if_else(melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - North West", "North West",
                            if_else(melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Outer East", "Outer East", 
                                            if_else(melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - South East", "South East", 
                                                    if_else(melbourne_2021_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - West", "West", 
                                                            melbourne_2021_transit_supply_by_SA4$sa4_name_2021))))))))

melbourne_2021_transit_supply_by_SA4$sa4_name_2021 <- factor(
  melbourne_2021_transit_supply_by_SA4$sa4_name_2021,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))

melbourne_2021_transit_supply_by_SA4$sa4_name_2021 <- melbourne_2021_transit_supply_by_SA4$sa4_name_2021 %>% 
  fct_rev()


melbourne_2021_transit_supply_by_SA4$transit_supply <- melbourne_2021_transit_supply_by_SA4$transit_supply %>% 
  factor(
    levels = c("Very High", 
               "High",
               "Above average", 
               "Below average", 
               "Low", 
               "Very Low",
               "Zero Supply"))


melbourne_2021_transit_supply_by_SA4$transit_supply <- melbourne_2021_transit_supply_by_SA4$transit_supply %>%
  fct_rev()


##Don't show SA1s, as population is more interesting

#ggbarstats(melbourne_2021_transit_supply_by_SA4,
#  x = transit_supply, 
#  y = sa4_name_2021, 
#  counts = SA1s) +
#  theme(legend.position = "bottom") +
#scale_fill_manual(values = c(
#  "darkgreen", 
#  "#53A212",
#  "lightgreen", 
#  "#F29C33", 
#  "#F7C387", 
#  "#F9D8B1", 
#  "#FFFFFF" 
#  )) 


```

```{r Greater_Melbourne_population_2016_by_SA4, fig.show="hold", echo = FALSE, fig.height=8, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne 2016: Transport Supply by SA1, overlayed with suburban rail network (black), SA4 boundaries (blue) and 2006 Melbourne extents (black)"}

melbourne_si_SA12016_16_census_week_aggregated$si_by_area <- left_join(
  melbourne_si_SA12016_16_census_week_aggregated$si_by_area,
  population_sa1_greater_melbourne_2016 %>% 
    select(sa1_code_2016, population),
  by = join_by(area_id == sa1_code_2016))


melbourne_2016_population_transit_supply_by_SA4 <- 
  melbourne_si_SA12016_16_census_week_aggregated$si_by_area %>% 
  st_drop_geometry() %>% 
  aggregate(population ~ sa4_name_2016  + transit_supply, sum) 


melbourne_2016_population_transit_supply_by_SA4$transit_supply <- factor(
  melbourne_2016_population_transit_supply_by_SA4$transit_supply, 
  levels = c(
    "Zero Supply",
    "Very Low",
    "Low",
    "Below average",
    "Above average",
    "High",
    "Very High")
)  


melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 <- if_else(
  melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Inner", "Inner", 
  if_else(
    melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Inner East", "Inner East",
    if_else(melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Inner South", "Inner South", 
            if_else(melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - North East", 
                    "North East", 
                    if_else(melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - North West", "North West",
                            if_else(melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - Outer East", "Outer East", 
                                            if_else(melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - South East", "South East", 
                                                    if_else(melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 == "Melbourne - West", "West", 
                                                            melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016))))))))


melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 <- factor(
  melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))

melbourne_2016_population_transit_supply_by_SA4_wider <- melbourne_2016_population_transit_supply_by_SA4 %>% 
  pivot_wider(names_from = "sa4_name_2016",
              values_from = "population")


melbourne_2016_population_transit_supply_by_SA4_wider[is.na(melbourne_2016_population_transit_supply_by_SA4_wider)] <- 0


melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 <- melbourne_2016_population_transit_supply_by_SA4$sa4_name_2016 %>% 
  fct_rev()

melbourne_2016_population_transit_supply_by_SA4$transit_supply <- melbourne_2016_population_transit_supply_by_SA4$transit_supply %>% 
  factor(
    levels = c("Very High", 
               "High",
               "Above average", 
               "Below average", 
               "Low", 
               "Very Low",
               "Zero Supply"))


melbourne_2016_population_transit_supply_by_SA4$transit_supply <- melbourne_2016_population_transit_supply_by_SA4$transit_supply %>%
  fct_rev()


#ggbarstats(melbourne_2016_population_transit_supply_by_SA4,
#  x = transit_supply, 
#  y = sa4_name_2016, 
#  counts = population) +
#  scale_fill_manual(values = c(
#  "darkgreen", 
#  "#53A212",
#  "lightgreen", 
#  "#F29C33", 
#  "#F7C387", 
#  "#F9D8B1", 
#  "#FFFFFF" 
#  )) 




```

```{r Greater_Melbourne_population_2021_by_SA4, fig.show="hold", echo = FALSE, fig.height=8, warning=FALSE, message=FALSE, cache=FALSE, out.width="100%", fig.cap="Greater Melbourne 2021: Transport Supply by SA1,  overlayed with suburban rail network (black), SA4 boundaries (blue) and 2006 Melbourne extents (black)"}

melbourne_si_SA12021_21_census_week_aggregated$si_by_area <- left_join(
  melbourne_si_SA12021_21_census_week_aggregated$si_by_area,
  population_sa1_greater_melbourne_2021 %>% 
    select(sa1_code_2021, population),
  by = join_by(area_id == sa1_code_2021))


melbourne_2021_population_transit_supply_by_SA4 <- 
  melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>% 
  st_drop_geometry() %>% 
  aggregate(population ~ sa4_name_2021  + transit_supply, sum) 

melbourne_2021_population_transit_supply_by_SA4$transit_supply <- factor(
  melbourne_2021_population_transit_supply_by_SA4$transit_supply, 
  levels = c(
    "Zero Supply",
    "Very Low",
    "Low",
    "Below average",
    "Above average",
    "High",
    "Very High")
)  


melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 <- if_else(
  melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Inner", "Inner", 
  if_else(
    melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Inner East", "Inner East",
    if_else(melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Inner South", "Inner South", 
            if_else(melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - North East", 
                    "North East", 
                    if_else(melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - North West", "North West",
                            if_else(melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - Outer East", "Outer East", 
                                            if_else(melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - South East", "South East", 
                                                    if_else(melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 == "Melbourne - West", "West", 
                                                            melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021))))))))


melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 <- factor(
  melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))

melbourne_2021_population_transit_supply_by_SA4_wider <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  pivot_wider(names_from = "sa4_name_2021",
              values_from = "population")


melbourne_2021_population_transit_supply_by_SA4_wider[is.na(melbourne_2021_population_transit_supply_by_SA4_wider)] <- 0



melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 <- melbourne_2021_population_transit_supply_by_SA4$sa4_name_2021 %>% 
  fct_rev()

#melbourne_2021_population_transit_supply_by_SA4 %>%
#  ggbarstats(y = sa4_name_2021,
#             x = transit_supply, 
#             counts = population)  +
#scale_fill_manual(values = c(
#  "darkgreen", 
#  "#53A212",
#  "lightgreen", 
#  "#F29C33", 
#  "#F7C387", 
#  "#F9D8B1", 
#  "#FFFFFF" 
#  )) 
  


pcol <- pop_comparison %>% 
  filter(category == "population_2021") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Population by Transport Supply",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 8),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  )

pcol_mornington <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "Mornington Peninsula") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Mornington Peninsula",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_inner_east <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "Inner East") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )



pcol_inner_south <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "Inner South") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner South",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_east <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "North East") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_west <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "North West") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
 # scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_outer_east <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "Outer East") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Outer East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_south_east <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "South East") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "South East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_west <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "West") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_inner <- melbourne_2021_population_transit_supply_by_SA4 %>% 
  filter(sa4_name_2021 == "Inner") %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, perc, fill = transit_supply)) + 
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
 scale_fill_manual(values = c("#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen", "white")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


#melbourne_si_SA12021_21_plot + 
#  ggspatial::annotation_scale(location = 'br') + 
#  ggspatial::annotation_north_arrow(location = 'tr') +
#inset_element(pcol, left = 0.0, bottom = 0.0, right = 0.40, top =0.30) +
#  inset_element(pcol_mornington, left = 0.56, bottom = 0.04, right = 0.86, top =0.18) +
#  inset_element(pcol_south_east, left = 0.82, bottom = 0.04, right = 1.12, top =0.18) +
#  inset_element(pcol_outer_east, left = 0.77, bottom = 0.60, right = 1.07, top =0.75) +
#  inset_element(pcol_north_east, left = 0.59, bottom = 0.81, right = 0.89, top =0.96) +
#  inset_element(pcol_north_west, left = 0.0, bottom = 0.81, right = 0.3, top =0.96) +
#  inset_element(pcol_west, left = 0.00, bottom = 0.30, right = 0.3, top =0.45) +
#  inset_element(pcol_inner, left = 0.17, bottom = 0.30, right = 0.47, top =0.45) +
#  inset_element(pcol_inner_south, left = 0.33, bottom = 0.25, right = 0.63, top =0.4) +
#  inset_element(pcol_inner_east, left = 0.77, bottom = 0.78, right = 1.07, top =0.93) 




```


```{r Greater_Melbourne_CCD_2021_by_suburbs_SI_scores, fig.show="hold", out.width="100%", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.cap="Greater Melbourne (2006 extents), SI score by CCD, week starting the day of the 2021 census, inner, middle and outer suburbs"}

#build table with inner, middle and outer
si_CCD2006_21_census_week_aggregated_middle_suburbs <- si_CCD2006_21_census_week_aggregated$si_by_area %>% st_filter(middle_lga07aust_region, .predicate = st_intersects)
si_CCD2006_21_census_week_aggregated_middle_suburbs$suburbs <- "middle"



outer_lga07aust_region <- vic_lga07aust_region[
  vic_lga07aust_region$LGANAME07 %in% c(
    "Cardinia (S)", "Casey (C)", "Frankston (C)", "Hume (C)", "Knox (C)", 
    "Mornington Peninsula (S)", "Maroondah (C)", "Melton (S)", "Nillumbik (S)", 
    "Whittlesea (C)", "Wyndham (C)", "Yarra Ranges (S)"),] 
outer_lga07aust_region <- st_union(outer_lga07aust_region)
si_CCD2006_21_census_week_aggregated_outer_suburbs <- si_CCD2006_21_census_week_aggregated$si_by_area %>% st_filter(outer_lga07aust_region, .predicate = st_intersects)
si_CCD2006_21_census_week_aggregated_outer_suburbs$suburbs <- "outer"

# Set boundaries between around inner suburbs       
inner_lga07aust_region <- vic_lga07aust_region[
  vic_lga07aust_region$LGANAME07 %in% 
    c("Melbourne (C)", "Yarra (C)", "Port Phillip (C)"),]
inner_lga07aust_region <- st_union(inner_lga07aust_region)


inner_lga07aust_region <- st_union(inner_lga07aust_region)
si_CCD2006_21_census_week_aggregated_inner_suburbs <- si_CCD2006_21_census_week_aggregated$si_by_area %>% st_filter(inner_lga07aust_region, .predicate = st_intersects)
si_CCD2006_21_census_week_aggregated_inner_suburbs$suburbs <- "inner"


# combine outer and middle
si_CCD2006_21_census_week_aggregated_outer_and_middle_suburbs <- add_row(
  si_CCD2006_21_census_week_aggregated_outer_suburbs,
  si_CCD2006_21_census_week_aggregated_middle_suburbs)
  
# CCDs that are within both the middle and outer suburbs (ie. on the boundary) 
# Lets assign them to the out
# so drop the duplicated rows
si_CCD2006_21_census_week_aggregated_outer_and_middle_suburbs <- si_CCD2006_21_census_week_aggregated_outer_and_middle_suburbs %>%
  arrange(area_id, rev(suburbs)) %>%
  filter(duplicated(area_id) == FALSE)


# combine inner with outer and middle
si_CCD2006_21_census_week_aggregated$si_by_area <- add_row(
  si_CCD2006_21_census_week_aggregated_outer_and_middle_suburbs,
  si_CCD2006_21_census_week_aggregated_inner_suburbs)
  
# CCDs that are within both the inner and middle suburbs (ie. on the boundary) 
# Lets assign them to the inner
# so drop the duplicated rows
si_CCD2006_21_census_week_aggregated_outer_and_middle_suburbs <- si_CCD2006_21_census_week_aggregated_outer_and_middle_suburbs %>%
  arrange(area_id, suburbs) %>%
  filter(duplicated(area_id) == FALSE)


#ggplot() +
#  geom_sf(data=si_CCD2006_21_census_week_aggregated$si_by_area, 
#aes(fill = suburbs), colour = NA) +
#  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.75)


#ggbetweenstats(data = si_CCD2006_21_census_week_aggregated$si_by_area,
#             x = suburbs,
#            y = SI) +
#scale_y_continuous(labels=label_number(accuracy = 1, big.mark = ","))
  
```

```{r Greater_Melbourne_2016_2021_scatterplot_SA12021, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = TRUE, fig.fullwidth = TRUE, fig.height = 8, fig.cap="Greater Melbourne: SI scores in 2016 and 2021 by SA1 (2021 boundaries), adjusted to set those <1 equal to 1 (for visual clarity)"}

si_by_area_2021_2024_wider <- si_by_area_2021_2024 %>% 
  st_drop_geometry() %>%
  na.omit() %>% 
  select(sa1_code_2021, Year, SI) %>%
  pivot_wider(names_from = "Year", 
              values_from = "SI") %>% 
  clean_names()

# Join back to get 2021 Transport Supply categories in tibble
si_by_area_2021_2024_wider <- left_join(
  si_by_area_2021_2024_wider, 
  si_by_area_2021_2024 %>% 
    st_drop_geometry() %>%
    na.omit() %>% 
    filter (Year == 2021) %>%  
    select(sa1_code_2021, transit_supply)
)

names(si_by_area_2021_2024_wider) <- c(
  "sa1_code_2021", 
  "x2021", 
  "x2024", 
  "transit_supply_2021"
)

# Convert SI scores <1 to =1 to clean up graph
si_by_area_2021_2024_wider$x2021_one_plus <- 
  if_else(si_by_area_2021_2024_wider$x2021 < 1, 
          1, 
          si_by_area_2021_2024_wider$x2021)
si_by_area_2021_2024_wider$x2024_one_plus <- 
  if_else(si_by_area_2021_2024_wider$x2024 < 1, 
          1, 
          si_by_area_2021_2024_wider$x2024)


si_by_area_2021_2024_wider$ratio <- si_by_area_2021_2024_wider$x2024_one_plus / 
  si_by_area_2021_2024_wider$x2021_one_plus


si_by_area_2021_2024_wider$ratio_binned <- if_else(
  si_by_area_2021_2024_wider$x2024 == 0, 
  if_else(
    si_by_area_2021_2024_wider$x2021 == 0,
    "Never served (black)", 
    "Service withdrawn (magenta)"),
  if_else(
    si_by_area_2021_2024_wider$x2021 == 0, 
    "New service", 
    if_else(
      si_by_area_2021_2024_wider$ratio < 0.90, 
      "Reduced 10% or more", 
      if_else(si_by_area_2021_2024_wider$ratio < 0.97, 
              "Reduced 3 to 10%", 
              if_else(si_by_area_2021_2024_wider$ratio < 0.99, 
                      "Reduced 1 to 3%", 
                      if_else(si_by_area_2021_2024_wider$ratio <1.01, 
                              "Within 1%", 
                              if_else(si_by_area_2021_2024_wider$ratio < 1.03, 
                                      "Increased 1 to 3%", 
                                      if_else(si_by_area_2021_2024_wider$ratio < 1.05, 
                                              "Increased 3 to 5%", 
                                              if_else(si_by_area_2021_2024_wider$ratio < 1.10, 
                                                      "Increased 5 to 10%", 
                                                  if_else(si_by_area_2021_2024_wider$ratio < 1.30, 
                                                      "Increased 10 to 30%", 
                                                      "Increased 30% or more")
                                              )
                                      )
                              )
                      )
              )
      )
    )
  )
)

si_by_area_2021_2024_wider$ratio_binned <- factor(
  si_by_area_2021_2024_wider$ratio_binned, 
   levels = c("New service",
              "Increased 30% or more",
              "Increased 10 to 30%",
              "Increased 5 to 10%",
              "Increased 3 to 5%",
              "Increased 1 to 3%",
              "Within 1%",
              "Reduced 1 to 3%",
              "Reduced 3 to 10%",
              "Reduced 10% or more",
              "Service withdrawn (magenta)",
              "Never served (black)"
              )
  )
                                                     
  
scatterplot_si_sa12021_2016_2021 <- si_by_area_2021_2024_wider %>% 
  st_drop_geometry() %>% 
  filter(ratio_binned != "Never served (black)") %>%
  ggscatterstats( 
  x = x2021_one_plus, 
  y = x2024_one_plus,
  type = "non-parametric",
  point.args = list(aes(colour = ratio_binned))
  ) +   
  scale_x_continuous(trans = "log", breaks = c(0.0001, 0.001, 0.01, 0.1, 1, 10, 100, 1000, 10000)) +
  scale_y_continuous(trans = "log", breaks = c(0.0001, 0.001, 0.01, 0.1, 1, 10, 100, 1000, 10000)) +
  theme(legend.position = "bottom", 
        text = element_text(size = 10)
        ) + 
  scale_color_brewer(palette = "RdYlBu", direction = 1)

#scatterplot_si_sa12021_2016_2021

#si_by_area_2021_2024_wider$Total <- 1
#si_by_area_2021_2024_wider$ratio_binned <- si_by_area_2021_2024_wider$ratio_binned %>% fct_rev()
#si_by_area_2021_2024_wider$ratio_binned <- si_by_area_2021_2024_wider$ratio_binned  %>% fct_shift(-1)
#si_by_area_2021_2024_wider %>% 
#  st_drop_geometry() %>% 
#  na.omit() %>%
#    ggbarstats(
#    x = ratio_binned,
#    y = Total
#  ) + 
#  theme(legend.position="bottom") +
#  scale_fill_manual(values = c("#5C66A0", "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "#FFFFFF"))
#si_by_area_2021_2024_wider$ratio_binned <- si_by_area_2021_2024_wider$ratio_binned  %>% fct_shift(1)
#si_by_area_2021_2024_wider$ratio_binned <- si_by_area_2021_2024_wider$ratio_binned %>% fct_rev()

```

```{r Greater_Melbourne_2016_2021_ratio_population_table, fig.show="hold", out.width = "90%", echo = FALSE, warning=FALSE, message=FALSE, cache = FALSE, include = TRUE, fig.height = 8, fig.cap="Greater Melbourne: changes in SI between 2016 and 2021, Population by SA4"}

# Join to 2021 population
si_by_area_2021_2024_wider <- left_join(
  si_by_area_2021_2024_wider,
  population_sa1_greater_melbourne_2021 %>% 
    select(sa1_code_2021, population))


# Join to SA4 names
si_by_area_2021_2024_wider <- left_join(
  si_by_area_2021_2024_wider,
  absmapsdata::sa12021 %>% 
    st_drop_geometry() %>%
    select(sa1_code_2021, sa4_name_2021))



greater_melbourne_ratio_population <- 
  si_by_area_2021_2024_wider %>% 
  aggregate(population ~ sa4_name_2021  + ratio_binned, sum) 


greater_melbourne_ratio_population$ratio_binned <- factor(
  greater_melbourne_ratio_population$ratio_binned, 
   levels = c("New service",
              "Increased 30% or more",
              "Increased 10 to 30%",
              "Increased 5 to 10%",
              "Increased 3 to 5%",
              "Increased 1 to 3%",
              "Within 1%",
              "Reduced 1 to 3%",
              "Reduced 3 to 10%",
              "Reduced 10% or more",
              "Service withdrawn (magenta)",
              "Never served (black)"
              )
  )
                        


greater_melbourne_ratio_population$sa4_name_2021 <- if_else(
  greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - Inner", "Inner", 
  if_else(
    greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - Inner East", "Inner East",
    if_else(greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - Inner South", "Inner South", 
            if_else(greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - North East", 
                    "North East", 
                    if_else(greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - North West", "North West",
                            if_else(greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - Outer East", "Outer East", 
                                            if_else(greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - South East", "South East", 
                                                    if_else(greater_melbourne_ratio_population$sa4_name_2021 == "Melbourne - West", "West", 
                                                            greater_melbourne_ratio_population$sa4_name_2021))))))))


greater_melbourne_ratio_population$sa4_name_2021 <- factor(
  greater_melbourne_ratio_population$sa4_name_2021,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))

greater_melbourne_ratio_population_wider <- greater_melbourne_ratio_population %>% 
  pivot_wider(names_from = "sa4_name_2021",
              values_from = "population")


greater_melbourne_ratio_population_wider[is.na(greater_melbourne_ratio_population_wider)] <- 0

#greater_melbourne_ratio_population$sa4_name_2021 <- greater_melbourne_ratio_population$sa4_name_2021 %>%
#  fct_rev()
#greater_melbourne_ratio_population$ratio_binned <- greater_melbourne_ratio_population$ratio_binned %>%
#  fct_rev()
#greater_melbourne_ratio_population$ratio_binned <- greater_melbourne_ratio_population$ratio_binned %>%
#  fct_shift(-1)
#greater_melbourne_ratio_population %>% 
#    ggbarstats(
#    x = ratio_binned,
#    y = sa4_name_2021,
#    counts = population,
#    palette = "RdYlBu",
#    direction = -1
#  ) + 
#  theme(legend.position="bottom") + 
#  scale_fill_manual(values = c("#5C66A0", "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "#FFFFFF"))

#greater_melbourne_ratio_population$Total <- 1
#greater_melbourne_ratio_population %>% 
#    ggbarstats(
#    x = ratio_binned,
#    y = Total,
#    counts = population,
#    palette = "RdYlBu",
#    direction = -1
#  ) + 
#  theme(legend.position="bottom") + 
#  scale_fill_manual(values = c("#5C66A0", "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "#FFFFFF"))
#greater_melbourne_ratio_population$ratio_binned <- greater_melbourne_ratio_population$ratio_binned %>%
#  fct_shift(1)

# shift factor back
si_by_area_2021_2024_wider$ratio_binned <- si_by_area_2021_2024_wider$ratio_binned %>% fct_shift(-1)

# Check expected values in chi-square
#janitor::chisq.test(si_by_area_2021_2024_wider %>% 
#  st_drop_geometry() %>% 
# tabyl(ratio_binned, sa4_name_2021))$expected
# <20% are less than 5, but "Service withdrawn (magenta)" is all less than 5. So check without sevice withdrawn 

# drop Service withdrawn (magenta)
#si_by_area_2021_2024_wider_no_withdrawn <- si_by_area_2021_2024_wider %>% filter(ratio_binned != "Service withdrawn (magenta)")
#si_by_area_2021_2024_wider_no_withdrawn$ratio_binned <- #si_by_area_2021_2024_wider_no_withdrawn$ratio_binned %>% fct_drop()

#janitor::chisq.test(si_by_area_2021_2024_wider_no_withdrawn %>% 
#  st_drop_geometry() %>% 
#  tabyl(ratio_binned, sa4_name_2021))
# obtain effectively the same result, so all good



```

```{r Greater_Melbourne_2016_2021_ratio_SA1_table, fig.show="hold", fig.dim = c(7.5,7.5),  echo = FALSE, warning=FALSE, message=FALSE, cache = TRUE, include = TRUE, fig.cap="Greater Melbourne: changes in SI between 2016 and 2021, by 2021 SA1, overlayed with 2006 Greater Melbourne boundary (black); 2021 SA4 boundaries (blue); and suburban railway lines (black)"}


si_by_area_2021_2024_wider_holding <- si_by_area_2021_2024_wider  

greater_melbourne_ratio_SA1 <- si_by_area_2021_2024_wider

greater_melbourne_ratio_SA1$ratio_binned <- factor(
  greater_melbourne_ratio_SA1$ratio_binned, 
   levels = c("New service",
              "Increased 30% or more",
              "Increased 10 to 30%",
              "Increased 5 to 10%",
              "Increased 3 to 5%",
              "Increased 1 to 3%",
              "Within 1%",
              "Reduced 1 to 3%",
              "Reduced 3 to 10%",
              "Reduced 10% or more",
              "Service withdrawn (magenta)",
              "Never served (black)"
              )
  )

greater_melbourne_ratio_SA1 <- 
  greater_melbourne_ratio_SA1 %>% 
  tabyl(ratio_binned, sa4_name_2021) 


greater_melbourne_ratio_SA1$ratio_binned <- factor(
  greater_melbourne_ratio_SA1$ratio_binned, 
   levels = c("New service",
              "Increased 30% or more",
              "Increased 10 to 30%",
              "Increased 5 to 10%",
              "Increased 3 to 5%",
              "Increased 1 to 3%",
              "Within 1%",
              "Reduced 1 to 3%",
              "Reduced 3 to 10%",
              "Reduced 10% or more",
              "Service withdrawn (magenta)",
              "Never served (black)"
              )
  )
                        

greater_melbourne_ratio_SA1_table <- greater_melbourne_ratio_SA1 %>%
  adorn_totals(where = c("row", "col")) %>%
  adorn_percentages(denominator = "all") %>% 
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  kable( 
    caption = "Greater Melbourne: Share of 2021 SA1s by change in transit service (2016 vs 2021) by SA4 region",
      align = "lrrrrrrr",
      col.names = c("Change", 
                   "Inner", "Inner East", "Inner South",
                   "North East", "North West",
                   "Outer East", "South East", 
                   "West", "M'ton Pen.", "Total")
      ) %>%
  kable_styling(font_size = 8) %>%
  kableExtra::column_spec(1, width = "1.75cm") %>% 
  kableExtra::column_spec(2, width = "1cm") %>%
  kableExtra::column_spec(3, width = "1cm") %>%
  kableExtra::column_spec(4, width = "1cm") %>%
  kableExtra::column_spec(5, width = "1cm") %>%
  kableExtra::column_spec(6, width = "1cm") %>%
  kableExtra::column_spec(7, width = "1cm") %>%
  kableExtra::column_spec(8, width = "1cm") %>%
  kableExtra::column_spec(9, width = "1cm") %>%
  kableExtra::column_spec(10, width = "1cm") %>%
  kableExtra::column_spec(11, width = "1.25cm")
  


#janitor::chisq.test(greater_melbourne_ratio_SA1)
#janitor::chisq.test(greater_melbourne_ratio_SA1)$expected
# 12 rows, 9 columns so 108 cells. 
# 9 have expected values below 5
# So 8% have expected value below 5, which is less than 20%. 
# Assumptions of chi-square hold. 
# But all below 5 values are in "Service withdawn (magenta)" 
#so run chi-square without that for comparison
#janitor::chisq.test(greater_melbourne_ratio_SA1 %>% filter(ratio_binned != "Service withdrawn (magenta)"))
#Result largely the same, so no problem
#janitor::chisq.test(greater_melbourne_ratio_SA1 %>% filter(ratio_binned != "Service withdrawn (magenta)"))$expected
# No expected values below 5, assumptions met. 
```

```{r Greater_Melbourne_2016_2021_ratio_map_working, fig.show="hold", fig.dim=c(7.5,7.5),  echo = FALSE, warning=FALSE, message=FALSE, cache = FALSE, include = TRUE, fig.cap="Greater Melbourne: changes in SI between 2016 and 2021, by 2021 SA1, overlayed with 2006 Greater Melbourne boundary (black); 2021 SA4 boundaries (blue); and suburban railway lines (black)"}


#greater_melbourne_ratio_population_wider %>%
#  select(ratio_binned, Inner, `Inner East`, `Inner South`, `North East`, `North West`, `Outer East`, `South East`, `West`, `Mornington Peninsula`) %>%
#  adorn_totals(where = c("row", "col")) %>%
#  adorn_percentages(denominator = "all") %>% 
#  adorn_pct_formatting() %>%
#  adorn_ns() %>%
#  kable( 
#    caption = "Greater Melbourne: Share of 2021 population living in SA1s by change in transit service (2016 vs 2021) by SA4 region",
#      align = "lrrrrrrr",
#      col.names = c("Change", 
#                   "Inner", "Inner East", "Inner South",
#                   "North East", "North West",
#                   "Outer East", "South East", 
#                   "West", "M'ton Pen.", "Total")
#      ) %>%
#  kable_styling(font_size = 8) %>%
#  kableExtra::column_spec(1, width = "1.75cm") %>% 
#  kableExtra::column_spec(2, width = "1cm") %>%
#  kableExtra::column_spec(3, width = "1cm") %>%
#  kableExtra::column_spec(4, width = "1cm") %>%
#  kableExtra::column_spec(5, width = "1cm") %>%
#  kableExtra::column_spec(6, width = "1cm") %>%
#  kableExtra::column_spec(7, width = "1cm") %>%
#  kableExtra::column_spec(8, width = "1cm") %>%
#  kableExtra::column_spec(9, width = "1cm") %>%
#  kableExtra::column_spec(10, width = "1cm") %>%
#  kableExtra::column_spec(11, width = "1.25cm")
  
si_by_area_2021_2024_wider <- left_join(
  absmapsdata::sa12021 %>%
    select(sa1_code_2021),
   si_by_area_2021_2024_wider, 
)

si_by_area_2021_2024_wider$ratio_binned <- si_by_area_2021_2024_wider$ratio_binned %>% fct_shift(+1)




pcol <- si_by_area_2021_2024_wider %>%
  st_drop_geometry() %>%
  aggregate(population ~ ratio_binned, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.6)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.03, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() + 
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "2021 pop. by SI change",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 8.5),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  )


pcol_mornington <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "Mornington Peninsula") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
  mutate(ratio_binned = factor(ratio_binned, 
   levels = c("New service",
              "Increased 30% or more",
              "Increased 10 to 30%",
              "Increased 5 to 10%",
              "Increased 3 to 5%",
              "Increased 1 to 3%",
              "Within 1%",
              "Reduced 1 to 3%",
              "Reduced 3 to 10%",
              "Reduced 10% or more",
              "Service withdrawn (magenta)",
              "Never served (black)"
   ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Mornington Peninsula",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )




si_by_area_2021_2024_wider$sa4_name_2021 <- if_else(
  si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - Inner", "Inner", 
  if_else(
    si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - Inner East", "Inner East",
    if_else(si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - Inner South", "Inner South", 
            if_else(si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - North East", 
                    "North East", 
                    if_else(si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - North West", "North West",
                            if_else(si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - Outer East", "Outer East", 
                                            if_else(si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - South East", "South East", 
                                                    if_else(si_by_area_2021_2024_wider$sa4_name_2021 == "Melbourne - West", "West", 
                                                            si_by_area_2021_2024_wider$sa4_name_2021))))))))


si_by_area_2021_2024_wider$sa4_name_2021 <- factor(
  si_by_area_2021_2024_wider$sa4_name_2021,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))





pcol_inner_east <-left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "Inner East") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )



pcol_inner_south <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "Inner South") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner South",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_east <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "North East") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_west <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "North West") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_outer_east <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "Outer East") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Outer East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_south_east <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "South East") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "South East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_west <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "West") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_inner <- left_join(data.frame(ratio_binned=levels(si_by_area_2021_2024_wider$ratio_binned)),
  si_by_area_2021_2024_wider %>%   st_drop_geometry() %>% 
  filter(sa4_name_2021 == "Inner") %>% 
  aggregate(population ~ ratio_binned, sum)) %>%
  mutate_all(~replace(., is.na(.), 0)) %>%   mutate(ratio_binned = factor(ratio_binned,     levels = c("New service",               "Increased 30% or more",               "Increased 10 to 30%",               "Increased 5 to 10%",               "Increased 3 to 5%",               "Increased 1 to 3%",               "Within 1%",               "Reduced 1 to 3%",               "Reduced 3 to 10%",               "Reduced 10% or more",               "Service withdrawn (magenta)",               "Never served (black)"    ))) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c( "#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )

```

```{r Greater_Melbourne_2016_2021_ratio_map_plot, fig.show="hold", fig.dim=c(7.5,7.5),  echo = FALSE, warning=FALSE, message=FALSE, cache = FALSE, include = TRUE, fig.cap="Greater Melbourne: changes in SI between 2016 and 2021, by 2021 SA1, overlayed with 2006 Greater Melbourne boundary (black); 2021 SA4 boundaries (blue); and suburban railway lines (black)"}


 #ggplot()+ 
#  geom_sf(data=si_by_area_2021_2024_wider %>% 
#            na.omit() %>%
##            filter(ratio_binned != "Never served (black)"),
#          aes(fill = ratio_binned), colour=NA) +  scale_fill_manual(values = c("#3A65A3", "#6D9DC4", "#A6CFE1", #"#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "magenta", "black")) +
#  theme(axis.text.x=element_blank(), #remove x axis labels
#        axis.ticks.x=element_blank(), #remove x axis ticks
#        axis.text.y=element_blank(),  #remove y axis labels
#        axis.ticks.y=element_blank(), #remove y axis ticks
#        legend.position="none",
#        legend.text = element_text(size = 10), 
#        legend.title = element_text(size = 10),
#        legend.key.size = unit(0.15, 'cm')) + 
#  guides(fill=guide_legend(nrow = 4)) +
  #geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
#  geom_sf(data=melbourne_sd07aust_region, 
#          colour="black", 
#          fill=NA) +
#  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1) + 
#  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +          ggspatial::annotation_scale(location = 'br') + 
#  ggspatial::annotation_north_arrow(location = 'tl') + 
#  inset_element(pcol, left = 0.0, bottom = 0.05, right = 0.48, top =0.39) +
#  inset_element(pcol_mornington, left = 0.59, bottom = 0.05, right = 0.89, top =0.2) +
#  inset_element(pcol_south_east, left = 0.8, bottom = 0.05, right = 1.1, top =0.20) +
#  inset_element(pcol_inner_east, left = 0.72, bottom = 0.85, right = 1.02, top =1) +
#  inset_element(pcol_north_east, left = 0.58, bottom = 0.85, right = 0.88, top =1)  +
#  inset_element(pcol_north_west, left = 0.0, bottom = 0.75, right = 0.3, top =0.9) +
#  inset_element(pcol_west, left = 0.0, bottom = 0.5, right = 0.3, top =0.65) +
#  inset_element(pcol_inner, left = 0.33, bottom = 0.33, right = 0.63, top =0.48) +
#  inset_element(pcol_inner_south, left = 0.32, bottom = 0.18, right = 0.62, top =0.33) + inset_element(pcol_outer_east, left = 0.72, bottom = 0.7, right = 1.02, top =0.85)  

```

```{r Greater_Melbourne_2021_social_needs, fig.dim=c(7.5,7.5), echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE,  fig.cap="Greater Melbourne 2021: Distribution of categories of composite social need index scores, overlayed with: 2006 Greater Melbourne boundary (black); SA4 boundaries (blue); and suburban railway lines (black)."}

#join to sa1 data, including lat and long of each sa1
social_2021_sa1_greater_melbourne <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021, sa3_name_2021, cent_lat, cent_long) %>%
    st_drop_geometry(),
  social_2021_sa1 
)

# from https://stackoverflow.com/questions/36817423/how-to-efficiently-calculate-distance-between-pair-of-coordinates-using-data-tab/42014364#42014364
dt.haversine <- function(lat_from, lon_from, lat_to, lon_to, r = 6378137){
  radians <- pi/180
  lat_to <- lat_to * radians
  lat_from <- lat_from * radians
  lon_to <- lon_to * radians
  lon_from <- lon_from * radians
  dLat <- (lat_to - lat_from)
  dLon <- (lon_to - lon_from)
  a <- (sin(dLat/2)^2) + (cos(lat_from) * cos(lat_to)) * (sin(dLon/2)^2)
  return(2 * atan2(sqrt(a), sqrt(1 - a)) * r)
}

social_2021_sa1_greater_melbourne$distance_m_to_GPO <- 
 dt.haversine(-37.813840, 
              144.963028,
              social_2021_sa1_greater_melbourne$cent_lat,
              social_2021_sa1_greater_melbourne$cent_long)


calculate_IRSAD_and_need_index <- function(social_dataset) {
  # scale all to 0 to 100
  social_dataset$IRSAD_100 <- rescale_max(
     social_dataset$IRSAD, to = c(0, 100))
  social_dataset$adult_no_car_100 <- rescale_max(
    social_dataset$adult_no_car, to = c(0, 100))
   social_dataset$accessibility_100 <- rescale_max(
     social_dataset$distance_m_to_GPO, to = c(0, 100))
   social_dataset$over_60_100 <- rescale_max(
     social_dataset$over_60, to = c(0, 100))
   social_dataset$disability_pension_100 <- rescale_max(
     social_dataset$disability_support_pension, to = c(0, 100))
   social_dataset$low_income_families_100 <- rescale_max(
     social_dataset$low_income_families, to = c(0, 100))
  social_dataset$adult_not_labour_force_100 <- rescale_max(
     social_dataset$adult_not_labour_force, to = c(0, 100))
  social_dataset$students_100 <- rescale_max(
     social_dataset$students, to = c(0, 100))
  social_dataset$age_five_to_nine_100 <- rescale_max(
     social_dataset$age_five_to_nine, to = c(0, 100))
  
  # calculate needs scores and scale to 100
  social_dataset$needs_score <- social_dataset$adult_no_car_100 * 0.19 +
    social_dataset$accessibility_100 * 0.15 + 
    social_dataset$over_60_100 * 0.14 + 
    social_dataset$disability_pension_100 * 0.12 + 
    social_dataset$low_income_families_100 * 0.10 + 
    social_dataset$adult_not_labour_force_100 * 0.09 + 
    social_dataset$students_100 * 0.09 + 
    social_dataset$age_five_to_nine_100 * 0.12
  social_dataset$needs_score_100 <- rescale_max(
     social_dataset$needs_score, to = c(0, 100))
  
  # weight IRSAD and needs score by total population
  social_dataset$total_need_IRSAD <- social_dataset$IRSAD *
    social_dataset$population
  social_dataset$total_transport_need <- social_dataset$needs_score * 
    social_dataset$population
  
  # create combined indicator 0 to 100
  social_dataset$combined_needs_index <- social_dataset$total_need_IRSAD + 
    social_dataset$total_transport_need 
  social_dataset$combined_needs_index <- rescale_max(
     social_dataset$combined_needs_index, to = c(0, 100))
  
  
  return(social_dataset %>% 
           select(sa1_code_2021, combined_needs_index, population, sa3_name_2021)) 
}

combined_needs_index_2021_sa1_greater_melbourne <- calculate_IRSAD_and_need_index(
  social_2021_sa1_greater_melbourne)

# Reuse the set thresholds function (but cheat by switching name of column two to SIs)
thresholds_holding <- combined_needs_index_2021_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  select(sa1_code_2021, combined_needs_index) 
names(thresholds_holding) <- c("area_id", "SI")  

thresholds_holding <- set_thresholds(thresholds_holding)
names(thresholds_holding[[1]]) <- c("sa1_code_2021", "combined_needs_index", "composite_needs")
thresholds_holding[[1]]$composite_needs <- thresholds_holding[[1]]$composite_needs %>% fct_other(keep = c("Very Low", "Low", "Below average", "Above average", "High", "Very High"), other_level = "NA")

#join to sa1 geometry data
combined_needs_index_2021_sa1_greater_melbourne <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021),
  thresholds_holding[[1]] 
)



combined_needs_2021_plot <- ggplot()+ 
  geom_sf(data=combined_needs_index_2021_sa1_greater_melbourne %>% na.omit(),
          aes(fill =  composite_needs), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none"
  ) +
    #    legend.text = element_text(size = 4), 
    #    legend.title = element_text(size = 5)) + 
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) + 
   geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
  geom_sf(data=melbourne_sd07aust_region, 
          colour="black", 
          fill=NA) +
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1) 
  

combined_needs_index_2021_sa1_greater_melbourne_sa4 <- combined_needs_index_2021_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  na.omit() %>%
  left_join(population_sa1_greater_melbourne_2021) %>%
  left_join(sa12021 %>% st_drop_geometry() %>% select(sa1_code_2021, sa4_name_2021)) 


combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 <- if_else(
  combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - Inner", "Inner", 
  if_else(
    combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - Inner East", "Inner East",
    if_else(combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - Inner South", "Inner South", 
            if_else(combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - North East", 
                    "North East", 
                    if_else(combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - North West", "North West",
                            if_else(combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - Outer East", "Outer East", 
                                            if_else(combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - South East", "South East", 
                                                    if_else(combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 == "Melbourne - West", "West", 
                                                            combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021))))))))

combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021 <- factor(
  combined_needs_index_2021_sa1_greater_melbourne_sa4$sa4_name_2021,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))



pcol <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
  #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() + 
    scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) + 
 guides(fill = "none", color = "none") +
  labs(
    title = "Population by needs",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 10),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()

  )


pcol_mornington <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "Mornington Peninsula") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Mornington Peninsula",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_inner_east <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "Inner East") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )



pcol_inner_south <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "Inner South") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner South",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_east <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "North East") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_west <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "North West") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_outer_east <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "Outer East") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Outer East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_south_east <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "South East") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "South East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_west <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "West") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_inner <- combined_needs_index_2021_sa1_greater_melbourne_sa4 %>% 
  filter(sa4_name_2021 == "Inner") %>%
  aggregate(population ~ composite_needs, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs)) +
 #scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.7)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs, perc+0.04, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01"))  +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


# combined_needs_2021_plot +
# ggspatial::annotation_scale(location = 'br') + 
#  ggspatial::annotation_north_arrow(location = 'tr') +
#inset_element(pcol, left = 0.0, bottom = 0.0, right = 0.4, top =0.30) +
#  inset_element(pcol_mornington, left = 0.59, bottom = 0.04, right = 0.89, top =0.19) +
#  inset_element(pcol_south_east, left = 0.85, bottom = 0.04, right = 1.15, top =0.19) +
#  inset_element(pcol_outer_east, left = 0.85, bottom = 0.60, right = 1.15, top =0.75) +
#  inset_element(pcol_north_east, left = 0.59, bottom = 0.81, right = 0.89, top =0.96)  +
#  inset_element(pcol_north_west, left = 0.0, bottom = 0.81, right = 0.3, top =0.96) +
#  inset_element(pcol_west, left = 0.00, bottom = 0.29, right = 0.3, top =0.43) +
#  inset_element(pcol_inner, left = 0.27, bottom = 0.27, right = 0.57, top =0.42) +
#  inset_element(pcol_inner_south, left = 0.32, bottom = 0.15, right = 0.62, top =0.28) +   
#  inset_element(pcol_inner_east, left = 0.75, bottom = 0.78, right = 1.05, top =0.93) 


```

```{r Greater_Melbourne_2016_social_needs, out.width="90%", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE,  fig.cap="Distribution of categories of composite social need index scores in 2016 (left) and 2021 (right), overlayed with: 2006 Greater Melbourne boundary (black); middle/outer and inner/middle suburb boundaries (grey); and suburban railway lines (black)."}

#join to sa1 data, including lat and long of each sa1
social_2016_sa1_greater_melbourne <- left_join(
  absmapsdata::sa12016 %>% 
    filter(gcc_name_2016 == "Greater Melbourne") %>% 
    select(sa1_code_2016, sa3_name_2016, cent_lat, cent_long) %>%
    st_drop_geometry(),
  social_2016_sa1,
  by = join_by(sa1_code_2016 == sa1_code_2016_11_digit)
  
)

# from https://stackoverflow.com/questions/36817423/how-to-efficiently-calculate-distance-between-pair-of-coordinates-using-data-tab/42014364#42014364

social_2016_sa1_greater_melbourne$distance_m_to_GPO <- 
 dt.haversine(-37.813840, 
              144.963028,
              social_2016_sa1_greater_melbourne$cent_lat,
              social_2016_sa1_greater_melbourne$cent_long)


calculate_IRSAD_and_need_index_no_disability_pension <- function(social_dataset, areas_of_interest) {
  # scale all to 0 to 100
  social_dataset$IRSAD_100 <- rescale_max(
     social_dataset$IRSAD, to = c(0, 100))
  social_dataset$adult_no_car_100 <- rescale_max(
    social_dataset$adult_no_car, to = c(0, 100))
   social_dataset$accessibility_100 <- rescale_max(
     social_dataset$distance_m_to_GPO, to = c(0, 100))
   social_dataset$over_60_100 <- rescale_max(
     social_dataset$over_60, to = c(0, 100))
   social_dataset$low_income_families_100 <- rescale_max(
     social_dataset$low_income_families, to = c(0, 100))
  social_dataset$adult_not_labour_force_100 <- rescale_max(
     social_dataset$adult_not_labour_force, to = c(0, 100))
  social_dataset$students_100 <- rescale_max(
     social_dataset$students, to = c(0, 100))
  social_dataset$age_five_to_nine_100 <- rescale_max(
     social_dataset$age_five_to_nine, to = c(0, 100))
  
  # calculate needs scores and scale to 100
  social_dataset$needs_score <- social_dataset$adult_no_car_100 * 0.19 +
    social_dataset$accessibility_100 * 0.15 + 
    social_dataset$over_60_100 * 0.14 + 
    social_dataset$low_income_families_100 * 0.10 + 
    social_dataset$adult_not_labour_force_100 * 0.09 + 
    social_dataset$students_100 * 0.09 + 
    social_dataset$age_five_to_nine_100 * 0.12
  social_dataset$needs_score_100 <- rescale_max(
     social_dataset$needs_score, to = c(0, 100))
  
  # weight IRSAD and needs score by total population
  social_dataset$total_need_IRSAD <- social_dataset$IRSAD *
    social_dataset$population
  social_dataset$total_transport_need <- social_dataset$needs_score * 
    social_dataset$population
  
  # create combined indicator 0 to 100
  social_dataset$combined_needs_index <- social_dataset$total_need_IRSAD + 
    social_dataset$total_transport_need 
  social_dataset$combined_needs_index <- rescale_max(
     social_dataset$combined_needs_index, to = c(0, 100))
  
  
  return(social_dataset %>% 
           select(areas_of_interest, combined_needs_index, population)) 
}

combined_needs_index_2021_sa1_greater_melbourne <- calculate_IRSAD_and_need_index_no_disability_pension(
  social_2021_sa1_greater_melbourne, areas_of_interest = "sa1_code_2021")

combined_needs_index_2016_sa1_greater_melbourne <- calculate_IRSAD_and_need_index_no_disability_pension(
  social_2016_sa1_greater_melbourne, areas_of_interest = "sa1_code_2016")



# 2021 Reuse the set thresholds function (but cheat by switching name of column two to SIs)
thresholds_holding <- combined_needs_index_2021_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  select(sa1_code_2021, combined_needs_index) 
names(thresholds_holding) <- c("area_id", "SI")  

thresholds_holding <- set_thresholds(thresholds_holding)
names(thresholds_holding[[1]]) <- c("sa1_code_2021", "combined_needs_index", "composite_needs")
thresholds_holding[[1]]$composite_needs <- thresholds_holding[[1]]$composite_needs %>% fct_other(keep = c("Very Low", "Low", "Below average", "Above average", "High", "Very High"), other_level = "NA")

#join to sa1 geometry data
combined_needs_index_2021_sa1_greater_melbourne <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021),
  thresholds_holding[[1]] 
)


# 2016 Reuse the set thresholds function (but cheat by switching name of column two to SIs)
thresholds_holding <- combined_needs_index_2016_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  select(sa1_code_2016, combined_needs_index) 
names(thresholds_holding) <- c("area_id", "SI")  

thresholds_holding <- set_thresholds(thresholds_holding)
names(thresholds_holding[[1]]) <- c("sa1_code_2016", "combined_needs_index", "composite_needs")
thresholds_holding[[1]]$composite_needs <- thresholds_holding[[1]]$composite_needs %>% fct_other(keep = c("Very Low", "Low", "Below average", "Above average", "High", "Very High"), other_level = "NA")

#join to sa1 geometry data
combined_needs_index_2016_sa1_greater_melbourne <- left_join(
  absmapsdata::sa12016 %>% 
    filter(gcc_name_2016 == "Greater Melbourne") %>% 
    select(sa1_code_2016),
  thresholds_holding[[1]] 
)


combined_needs_2016_plot <- ggplot()+ 
  geom_sf(data=combined_needs_index_2016_sa1_greater_melbourne %>% na.omit(),
          aes(fill =  composite_needs), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none") +
#        legend.text = element_text(size = 4), 
 #       legend.title = element_text(size = 5)) + 
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) + 
   geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
  geom_sf(data=melbourne_sd07aust_region, 
          colour="black", 
          fill=NA) +
  geom_sf(data=melbourne_railway_trips_shape_2016, linetype = "twodash", size = 0.1) 

  
#combined_needs_2016_plot + combined_needs_2021_plot 


```

```{r Greater_Melbourne_2016_social_needs_scatterplot, out.width="100%", echo = FALSE, eval = FALSE, warning=FALSE, message=FALSE, cache=FALSE,  fig.cap="Changes between social need index scores in 2016 and 2021."}

# join 2016 to correspondence file 
combined_needs_index_2016_2021_comparison <- left_join(
  combined_needs_index_2016_sa1_greater_melbourne %>% 
    st_drop_geometry(), 
  CG_SA1_2016_SA1_2021
) 
combined_needs_index_2016_2021_comparison$Year <- "x2021"

# join 2021 to correspondence file and add to comparison dataframe
combined_needs_index_2016_2021_comparison <- add_row(
  combined_needs_index_2016_2021_comparison, 
  left_join(
    combined_needs_index_2021_sa1_greater_melbourne %>% 
      st_drop_geometry(), 
    CG_SA1_2016_SA1_2021
    ) 
)
# set 2021 as year
combined_needs_index_2016_2021_comparison <- combined_needs_index_2016_2021_comparison %>%
  mutate(Year=replace_na(Year, "x2024"))

# filter to only compare those with good quality
combined_needs_index_2016_2021_comparison_wider <- pivot_wider( data = combined_needs_index_2016_2021_comparison %>% 
  filter(indiv_to_region_qlty_indicator == "Good") %>% 
    filter(ratio_from_to == 1) %>%
    select(sa1_code_2016, combined_needs_index, Year) %>% 
    distinct(), 
  values_from = "combined_needs_index",
  names_from = "Year")

# join to SA3 and SA4
combined_needs_index_2016_2021_comparison_wider <- left_join(
  combined_needs_index_2016_2021_comparison_wider, 
  absmapsdata::sa12016 %>% 
    st_drop_geometry() %>%
    filter(gcc_name_2016 == "Greater Melbourne") %>%
    select(sa1_code_2016, sa3_name_2016, sa4_name_2016)
)

# join to 2016 categories
combined_needs_index_2016_2021_comparison_wider <- left_join(
  combined_needs_index_2016_2021_comparison_wider, 
  combined_needs_index_2016_sa1_greater_melbourne %>% 
    select(sa1_code_2016, composite_needs)
)

combined_needs_index_2016_2021_scatterstats <- combined_needs_index_2016_2021_comparison_wider %>% 
  ggscatterstats(
  x = "x2021", 
  y = "x2024",
  point.args = list(aes(colour = sa4_name_2016, shape = composite_needs))
) + 
  theme(legend.position="bottom", 
        text = element_text(size = 6))

```



```{r Greater_Melbourne_2021_needs_gap_scatterplot, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE,  fig.dim=c(7.5,7.5), fig.cap="Greater Melbourne 2021, SI and Combined Needs Index scores. SI scores < 10 rounded up to equal 10 to improve legibility."}

melbourne_needs_gap_sa1_2021 <- 
  left_join(combined_needs_index_2021_sa1_greater_melbourne %>% 
              st_drop_geometry() %>%
              na.omit(), 
            melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>% 
              st_drop_geometry() %>% 
              na.omit(),
            by = join_by(sa1_code_2021 == area_id)
  )


#join to sa2 sa3 and sa4 names to identify locations

melbourne_needs_gap_sa1_2021 <- left_join(
  melbourne_needs_gap_sa1_2021, 
  absmapsdata::sa12021 %>% 
    st_drop_geometry() %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>%
    select(sa1_code_2021, sa2_name_2021, sa3_name_2021, sa4_name_2021)
)

melbourne_needs_gap_sa1_2021$SI_greater_than_one <- ifelse(
  melbourne_needs_gap_sa1_2021$SI < 1, 
  1, 
  melbourne_needs_gap_sa1_2021$SI
)

#ggscatterstats(data = melbourne_needs_gap_sa1_2021, 
#               y = "combined_needs_index", 
#               x = "SI_greater_than_one"
               #label.var = sa2_name_2021, 
               #label.expression = combined_needs_index > 40 & SI_greater_than_one < 575 |
               #  combined_needs_index < 4.5 & SI_greater_than_one > 7000,
  #point.args = list(aes(colour = transit_supply, shape = composite_needs))
#  ) + 
#  theme(
#  legend.position="bottom",
#        legend.text = element_text(size = 8), 
#        legend.title = element_text(size = 8)) +
#  scale_x_log10() + 
#  scale_y_log10()


melbourne_needs_gap_sa1_2021$SI_greater_than_ten <- ifelse(
  melbourne_needs_gap_sa1_2021$SI < 10, 
  10, 
  melbourne_needs_gap_sa1_2021$SI
)

melbourne_needs_gap_scatterplot_2021 <- ggscatterstats(data = melbourne_needs_gap_sa1_2021, 
               y = "combined_needs_index", 
               x = "SI_greater_than_ten",
               type = "non_parametric",
               results.subtitle = FALSE,
               label.var = sa2_name_2021, 
               label.expression = combined_needs_index > 40 & SI_greater_than_one < 575 |
                 combined_needs_index < 4.5 & SI_greater_than_one > 7000,
  point.args = list(aes(colour = transit_supply, shape = composite_needs))) +
  scale_color_manual(values = c("grey", "#F9D8B1", "#F7C387", 
                               "#F29C33", "lightgreen", "#53A212", "darkgreen")) + 
  theme(
  legend.position="bottom",
  legend.text = element_text(size = 5), 
  legend.title = element_text(size = 5), 
  text = element_text(size = 9)
  ) +
  scale_x_log10() + 
  scale_y_log10()

```

```{r Greater_Melbourne_2021_needs_gap_zones, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne 2021, SA1s within each SI and Combined Needs Index grouping"}


melbourne_sa1_need_gap_crosstable_2021 <- melbourne_needs_gap_sa1_2021 %>% 
  tabyl(transit_supply,composite_needs) %>% 
  untabyl() %>% 
  select(transit_supply, `Very Low`, Low, `Below average`, `Above average`, High, `Very High`)


melbourne_sa1_need_gap_crosstable_2021_longer <- melbourne_sa1_need_gap_crosstable_2021[,1:7] %>% 
  as_tibble() %>%
  pivot_longer(cols = 2:7, 
               names_to = "composite_needs", 
               values_to = "SA1s") 
melbourne_sa1_need_gap_crosstable_2021_longer$composite_needs <- factor(
  melbourne_sa1_need_gap_crosstable_2021_longer$composite_needs, 
  levels = c("Very Low", "Low", "Below average", "Above average", "High", "Very High"))

#Show only table in paper
#melbourne_sa1_need_gap_crosstable_2021_longer %>%
#  ggbarstats(x = transit_supply, 
#             y = composite_needs, 
#            counts = "SA1s"
#             ) + 
#  theme(legend.position="bottom")

Greater_Melbourne_2021_needs_gap_zones_table <- melbourne_sa1_need_gap_crosstable_2021[,1:7] %>% as_tibble() %>%
  adorn_totals(where = c("row", "col")) %>%
  adorn_percentages(denominator = "col") %>%
  adorn_pct_formatting() %>% 
  adorn_ns() %>% 
  kable(align = "lrrrrrrr", 
        caption = "Greater Melbourne 2021, SA1s within each SI and Combined Needs Index grouping") %>% 
  add_header_above(c(" " = 1, "Combined Needs Index Category" = 6, " " = 1)) %>%
  kable_styling(font_size = 8) %>%
  kableExtra::column_spec(1, width = "2.0cm") %>% 
  kableExtra::column_spec(2, width = "1.25cm") %>%
  kableExtra::column_spec(3, width = "1.25cm") %>%
  kableExtra::column_spec(4, width = "1.25cm") %>%
  kableExtra::column_spec(5, width = "1.25cm") %>%
  kableExtra::column_spec(6, width = "1.25cm") %>%
  kableExtra::column_spec(7, width = "1.25cm") %>%
  kableExtra::column_spec(8, width = "1.5cm")
  
  


```

```{r Greater_Melbourne_2021_needs_gap_population, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne 2021, Populations within each SI and Combined Needs Index grouping"}

melbourne_needs_gap_sa1_2021 <- left_join(melbourne_needs_gap_sa1_2021, 
          population_sa1_greater_melbourne_2021 %>% 
            select(sa1_code_2021, population))

melbourne_sa1_need_gap_population_crosstable_2021 <- melbourne_needs_gap_sa1_2021 %>% aggregate(population ~ transit_supply + composite_needs, sum)


# melbourne_sa1_need_gap_population_crosstable_2021 %>% 
#  pivot_wider(names_from = composite_needs, values_from = population) %>%
#  adorn_totals(where = c("row", "col")) %>%
#  adorn_percentages(denominator = "all") %>%
#  adorn_pct_formatting() %>% 
#  adorn_ns() %>% 
#  select(transit_supply, `Very High`, `High`, `Above average`, `Below average`, Low, `Very Low`, Total) %>%
#  kable(align = "lrrrrrrr", 
#        caption = "Greater Melbourne 2021, Population in each SI and Combined Needs Index grouping",
#        col.names = c("Supply", 
#                   "Very High", "High", 
#                   "Above Average", "Below Average",
#                   "Low", "Very Low", "Total")) %>% 
#  add_header_above(c(" " = 1, "Combined Needs Index Category" = 6, " " = 1)) %>%
#  kable_styling(font_size = 8) %>%
#  kableExtra::column_spec(1, width = "2.5cm") %>% 
#  kableExtra::column_spec(2, width = "1.25cm") %>%
#  kableExtra::column_spec(3, width = "1.25cm") %>%
#  kableExtra::column_spec(4, width = "1.25cm") %>%
#  kableExtra::column_spec(5, width = "1.25cm") %>%
#  kableExtra::column_spec(6, width = "1.25cm") %>%
#  kableExtra::column_spec(7, width = "1.25cm") %>%
#  kableExtra::column_spec(8, width = "1.5cm")


melbourne_sa1_need_gap_population_crosstable_2021$composite_needs <- factor(
  melbourne_sa1_need_gap_population_crosstable_2021$composite_needs, 
  levels = c("Very Low", "Low", "Below average", "Above average", "High", "Very High"))
melbourne_sa1_need_gap_population_crosstable_2021$transit_supply <- factor(
  melbourne_sa1_need_gap_population_crosstable_2021$transit_supply, 
  levels = c("Zero Supply", "Very Low", "Low", "Below average", "Above average", "High", "Very High"))

#show only table in paper 
#melbourne_sa1_need_gap_population_crosstable_2021 %>%
#    ggbarstats(x = transit_supply, 
#             y = composite_needs, 
#             counts = "population"
#             ) + 
#  scale_fill_manual(values = c("darkgreen","#53A212", "lightgreen", "#F29C33","#F7C387", "#F9D8B1", "#FFFFFF" )) + 
#  theme(legend.position="bottom")


  
```

```{r Greater_Melbourne_2021_needs_gap_map, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width="100%", fig.cap="Greater Melbourne 2021 SI groupings, overlayed with SA1s with very high transport need areas with zero or very low Transport Supply (red)."}

very_high_needs_very_low_zero_supply_2021 <- melbourne_needs_gap_sa1_2021 %>% filter(transit_supply %in% c("Zero Supply","Very Low")) %>% filter(composite_needs == "Very High") 

areas_of_interest <-  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021)

very_high_needs_very_low_zero_supply_2021 <- right_join(areas_of_interest, very_high_needs_very_low_zero_supply_2021)

melbourne_2021_needs_gap_no_suburbs <-  melbourne_si_SA12021_21_plot + 
  geom_sf(data=very_high_needs_very_low_zero_supply_2021, fill = "red") 
 
very_high_needs_very_low_zero_supply_2021$very_high_needs_very_low_zero_supply_2021 <- TRUE

melbourne_needs_gap_sa1_2021 <- left_join(
  melbourne_needs_gap_sa1_2021, 
  very_high_needs_very_low_zero_supply_2021 %>%
    st_drop_geometry() %>% 
    select(sa1_code_2021, very_high_needs_very_low_zero_supply_2021) 
)



melbourne_needs_gap_sa1_2021$very_high_needs_very_low_zero_supply_2021[is.na(melbourne_needs_gap_sa1_2021$very_high_needs_very_low_zero_supply_2021)] <- FALSE


melbourne_needs_gap_sa1_2021$sa4_name_2021 <- if_else(
  melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - Inner", "Inner", 
  if_else(
    melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - Inner East", "Inner East",
    if_else(melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - Inner South", "Inner South", 
            if_else(melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - North East", 
                    "North East", 
                    if_else(melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - North West", "North West",
                            if_else(melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - Outer East", "Outer East", 
                                            if_else(melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - South East", "South East", 
                                                    if_else(melbourne_needs_gap_sa1_2021$sa4_name_2021 == "Melbourne - West", "West", 
                                                            melbourne_needs_gap_sa1_2021$sa4_name_2021))))))))


melbourne_needs_gap_sa1_2021$sa4_name_2021 <- factor(
  melbourne_needs_gap_sa1_2021$sa4_name_2021,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))

melbourne_needs_gap_sa1_2021$sa4_name_2021 <- melbourne_needs_gap_sa1_2021$sa4_name_2021 %>% fct_rev()

#melbourne_needs_gap_sa1_2021 %>% 
#  st_drop_geometry() %>%
#  ggbarstats(
#    x = very_high_needs_very_low_zero_supply_2021,
#    y = sa4_name_2021,
#    count = population
#  ) +
#  scale_fill_manual(values = c("#E83F33", "#F9D785")) +
#  theme(legend.position = "bottom")


```

```{r Greater_Melbourne_2016_needs_gap_scatterplot, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.height=8, fig.cap="Greater Melbourne 2016, SI and Combined Needs Index scores, with SI scores < 1 rounded up to equal 1. "}


melbourne_needs_gap_sa1_2016 <- 
  left_join(combined_needs_index_2016_sa1_greater_melbourne %>% 
              st_drop_geometry() %>%
              na.omit(), 
            melbourne_si_SA12016_16_census_week_aggregated$si_by_area %>% 
              st_drop_geometry() %>% 
              na.omit(),
            by = join_by(sa1_code_2016 == area_id)
  )


#join to sa2 sa3 and sa4 names to identify locations

melbourne_needs_gap_sa1_2016 <- left_join(
  melbourne_needs_gap_sa1_2016, 
  absmapsdata::sa12016 %>% 
    st_drop_geometry() %>% 
    filter(gcc_name_2016 == "Greater Melbourne") %>%
    select(sa1_code_2016, sa2_name_2016, sa3_name_2016, sa4_name_2016)
)


melbourne_needs_gap_sa1_2016$SI_greater_than_one <- ifelse(
  melbourne_needs_gap_sa1_2016$SI < 1, 
  1, 
  melbourne_needs_gap_sa1_2016$SI
)

melbourne_needs_gap_sa1_2016$SI_greater_than_ten <- ifelse(
  melbourne_needs_gap_sa1_2016$SI < 10, 
  10, 
  melbourne_needs_gap_sa1_2016$SI
)




melbourne_needs_gap_scatterplot_2016 <- ggscatterstats(data = melbourne_needs_gap_sa1_2016, 
               y = "combined_needs_index", 
               x = "SI_greater_than_ten",
               type = "non_parametric",
               results.subtitle = FALSE,
               label.var = sa2_name_2016, 
               label.expression = combined_needs_index > 40 & SI_greater_than_one < 562 |
               combined_needs_index < 4.5 & SI_greater_than_one > 6200,
   point.args = list(aes(colour = transit_supply, shape = composite_needs))) +
  scale_color_manual(values = c("grey", "#F9D8B1", "#F7C387", 
                               "#F29C33", "lightgreen", "#53A212", "darkgreen"))+
  theme(
  legend.position="bottom",
  legend.text = element_text(size = 4), 
  legend.title = element_text(size = 5), 
  text = element_text(size = 6)) +
  scale_x_log10() + 
  scale_y_log10()

```

```{r Greater_Melbourne_2016_needs_gap_zones, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne 2016, SA1s within each SI and Combined Needs Index grouping"}


melbourne_sa1_need_gap_crosstable_2016 <- melbourne_needs_gap_sa1_2016 %>% 
  tabyl(transit_supply,composite_needs) %>% 
  untabyl() %>% 
  select(transit_supply, `Very Low`, Low, `Below average`, `Above average`, High, `Very High`)

Greater_Melbourne_2016_needs_gap_zones_table <- melbourne_sa1_need_gap_crosstable_2016[,1:7] %>% as_tibble() %>%
  adorn_totals(where = c("row", "col")) %>%
  adorn_percentages(denominator = "col") %>%
  adorn_pct_formatting() %>% 
  adorn_ns() %>% 
  kable(align = "lrrrrrrr", caption = "Greater Melbourne 2016, SA1s within each SI and Combined Needs Index grouping") %>%
  kable_styling(font_size = 7)

melbourne_sa1_need_gap_crosstable_2016_longer <- melbourne_sa1_need_gap_crosstable_2016[,1:7] %>% 
  as_tibble() %>%
  pivot_longer(cols = 2:7, 
               names_to = "composite_needs", 
               values_to = "SA1s") 
melbourne_sa1_need_gap_crosstable_2016_longer$composite_needs <- factor(
  melbourne_sa1_need_gap_crosstable_2016_longer$composite_needs, 
  levels = c("Very Low", "Low", "Below average", "Above average", "High", "Very High"))

#melbourne_sa1_need_gap_crosstable_2016_longer %>%
#  ggbarstats(x = transit_supply, 
#             y = composite_needs, 
#             counts = "SA1s"
#             ) + 
#  theme(legend.position="bottom")

```

```{r Greater_Melbourne_2016_needs_gap_population, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Greater Melbourne 2016, Populations within each SI and Combined Needs Index grouping"}

melbourne_sa1_need_gap_population_crosstable_2016 <- melbourne_needs_gap_sa1_2016 %>% aggregate(population ~ transit_supply + composite_needs, sum)


#melbourne_sa1_need_gap_population_crosstable_2016 %>% 
# pivot_wider(names_from = composite_needs, values_from = population) %>%
#  adorn_totals(where = c("row", "col")) %>%
#  adorn_percentages(denominator = "all") %>%
#  adorn_pct_formatting() %>% 
#  adorn_ns() %>% 
#  select(transit_supply, `Very High`, `High`, `Above average`, `Below average`, Low, `Very Low`, Total) %>%
#  kable(align = "lrrrrrrr", 
#        caption = "Greater Melbourne 2016, Population in each SI and Combined Needs Index grouping",
#        col.names = c("Supply", 
 #                  "Very High", "High", 
 #                  "Above Average", "Below Average",
#                   "Low", "Very Low", "Total")) %>% 
# add_header_above(c(" " = 1, "Combined Needs Index Category" = 6, " " = 1)) %>%
#  kable_styling(font_size = 8) %>%
#  kableExtra::column_spec(1, width = "2.5cm") %>% 
#  kableExtra::column_spec(2, width = "1.25cm") %>%
#  kableExtra::column_spec(3, width = "1.25cm") %>%
#  kableExtra::column_spec(4, width = "1.25cm") %>%
#  kableExtra::column_spec(5, width = "1.25cm") %>%
#  kableExtra::column_spec(6, width = "1.25cm") %>%
#  kableExtra::column_spec(7, width = "1.25cm") %>%
# kableExtra::column_spec(8, width = "1.5cm")



melbourne_sa1_need_gap_population_crosstable_2016$composite_needs <- factor(
  melbourne_sa1_need_gap_population_crosstable_2016$composite_needs, 
  levels = c("Very Low", "Low", "Below average", "Above average", "High", "Very High"))
melbourne_sa1_need_gap_population_crosstable_2016$transit_supply <- factor(
  melbourne_sa1_need_gap_population_crosstable_2016$transit_supply, 
  levels = c("Zero Supply", "Very Low", "Low", "Below average", "Above average", "High", "Very High"))

#melbourne_sa1_need_gap_population_crosstable_2016 %>%
#  ggbarstats(x = transit_supply, 
#             y = composite_needs, 
#             counts = "population"
#             ) + 
#  scale_fill_manual(values = c("darkgreen","#53A212", "lightgreen", "#F29C33", "#F7C387", "#F9D8B1", "#FFFFFF")) + 
#  theme(legend.position="bottom")

```

```{r Greater_Melbourne_2016_needs_gap_map, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width="100%", fig.cap="Greater Melbourne 2016 SI groupings, overlayed with SA1s with very high transport need areas with zero or very low public Transport Supply (red)."}

very_high_needs_very_low_zero_supply_2016 <- melbourne_needs_gap_sa1_2016 %>% filter(transit_supply %in% c("Zero Supply","Very Low")) %>% filter(composite_needs == "Very High") 

areas_of_interest <-  absmapsdata::sa12016 %>% 
    filter(gcc_name_2016 == "Greater Melbourne") %>% 
    select(sa1_code_2016)

very_high_needs_very_low_zero_supply_2016 <- right_join(areas_of_interest, very_high_needs_very_low_zero_supply_2016)

melbourne_2016_needs_gap_no_suburbs <- melbourne_si_SA12016_16_plot +  
  geom_sf(data=very_high_needs_very_low_zero_supply_2016, fill = "red") 


very_high_needs_very_low_zero_supply_2016$very_high_needs_very_low_zero_supply_2016 <- TRUE

melbourne_needs_gap_sa1_2016 <- left_join(
  melbourne_needs_gap_sa1_2016, 
  very_high_needs_very_low_zero_supply_2016 %>%
    st_drop_geometry() %>% 
    select(sa1_code_2016, very_high_needs_very_low_zero_supply_2016) 
)


melbourne_needs_gap_sa1_2016$very_high_needs_very_low_zero_supply_2016[is.na(melbourne_needs_gap_sa1_2016$very_high_needs_very_low_zero_supply_2016)] <- FALSE


melbourne_needs_gap_sa1_2016$sa4_name_2016 <- if_else(
  melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - Inner", "Inner", 
  if_else(
    melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - Inner East", "Inner East",
    if_else(melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - Inner South", "Inner South", 
            if_else(melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - North East", 
                    "North East", 
                    if_else(melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - North West", "North West",
                            if_else(melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - Outer East", "Outer East", 
                                            if_else(melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - South East", "South East", 
                                                    if_else(melbourne_needs_gap_sa1_2016$sa4_name_2016 == "Melbourne - West", "West", 
                                                            melbourne_needs_gap_sa1_2016$sa4_name_2016))))))))


melbourne_needs_gap_sa1_2016$sa4_name_2016 <- factor(
  melbourne_needs_gap_sa1_2016$sa4_name_2016,
  levels = c("Mornington Peninsula",
             "West",
             "South East", 
             "Outer East", 
             "North West", 
             "North East", 
             "Inner South",
             "Inner East",
             "Inner"))

melbourne_needs_gap_sa1_2016$sa4_name_2016 <- melbourne_needs_gap_sa1_2016$sa4_name_2016 %>% fct_rev()

#melbourne_needs_gap_sa1_2016 %>% 
#  st_drop_geometry() %>%
#  ggbarstats(
#    x = very_high_needs_very_low_zero_supply_2016,
#    y = sa4_name_2016,
#    count = population
#  ) +
#  scale_fill_manual(values = c("#E83F33", "#F9D785")) +
#  theme(legend.position = "bottom")


```




```{r Greater_Melbourne_2016_needs_gap_population_table, echo = FALSE, eval = FALSE}

Greater_Melbourne_2016_needs_gap_population_table

```

```{r Greater_Melbourne_2021_needs_gap_population_table, echo = FALSE, eval = FALSE}

Greater_Melbourne_2021_needs_gap_population_table

```

```{r Greater_Melbourne_2016_needs_gap_map_figure, eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.cap="Greater Melbourne Transport Supply groupings overlayed with SA1s with very high transport need areas with zero or very low public Transport Supply (red).", fig.ncol = 2, out.width = "100%", fig.align = "center", fig.subcap = c("2016", "2021")}

pcol_vhigh_vlow_zero <- melbourne_needs_gap_sa1_2016  %>%
  st_drop_geometry() %>%
  filter(composite_needs == "Very High") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, population, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, population + 30000, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Very High Needs population",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  )


pcol <- melbourne_needs_gap_sa1_2016  %>%
  st_drop_geometry() %>%
  filter(composite_needs != "Very High") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, population, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, population + 110000, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of population",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  )

#melbourne_2016_needs_gap_no_suburbs + 
 # theme(legend.position = "none") + 
#  ggspatial::annotation_scale(location = 'br') +
#  ggspatial::annotation_north_arrow(location = 'tl') +
#  inset_element(pcol, left = 0.0, bottom = 0.18, right = 0.45, top =0.38) +
#  inset_element(pcol_vhigh_vlow_zero, left = 0.50, bottom = 0.8, right = 0.95, top =1) 
  
  



pcol_vhigh_vlow_zero <- melbourne_needs_gap_sa1_2021  %>%
  st_drop_geometry() %>%
  filter(composite_needs == "Very High") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, population, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, population + 32000, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 1.8) +
  coord_flip() +
   scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Very High Needs population",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  )


pcol <- melbourne_needs_gap_sa1_2021  %>%
  st_drop_geometry() %>%
  filter(composite_needs != "Very High") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, population, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, population + 110000, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 1.8) +
  coord_flip() +
   scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of population",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  )

#melbourne_2021_needs_gap_no_suburbs + 
#  theme(legend.position = "none") +
#  inset_element(pcol, left = 0.0, bottom = 0.18, right = 0.45, top =0.38) +
#  inset_element(pcol_vhigh_vlow_zero, left = 0.55, bottom = 0.8, right = 1.0, top =1) 


```

```{r Greater_Melbourne_2021_needs_gap_map_figure, eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.dim=c(7.5,7.5),  fig.cap="Greater Melbourne 2021: Transport Supply groupings for Very High needs SA1s (only)"}




pcol <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% na.omit() %>% 
  filter(composite_needs == "Very High") %>% 
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.75)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) + 
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Population by Transport Supply",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 8),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  )

pcol_mornington <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "Mornington Peninsula") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Mornington Peninsula",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_inner_east <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "Inner East") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )



pcol_inner_south <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "Inner South") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner South",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_east <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "North East") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_north_west <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "North West") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
   scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "North West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_outer_east <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "Outer East") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Outer East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_south_east <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>%  
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "South East") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
   scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "South East",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_west <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "West") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "West",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )


pcol_inner <- melbourne_needs_gap_sa1_2021 %>% st_drop_geometry() %>% 
  filter(composite_needs == "Very High") %>% 
  filter(sa4_name_2021 == "Inner") %>%
  aggregate(population ~ transit_supply, sum) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, perc, fill = transit_supply)) +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,0.8)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, perc+0.05, label = glue::glue("{label_percent(accuracy = 1)(perc)}")), size = 2) +
  coord_flip() +
   scale_fill_manual(values = c("lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Inner",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 6),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  )

melbourne_needs_gap_sa1_2021 <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>%
    select(sa1_code_2021), 
  melbourne_needs_gap_sa1_2021
)


#ggplot()+ 
#  geom_sf(data=melbourne_needs_gap_sa1_2021 %>% 
#          filter(composite_needs == "Very High"),
##          aes(fill = transit_supply), colour=NA) +
#  theme(axis.text.x=element_blank(), #remove x axis labels
#        axis.ticks.x=element_blank(), #remove x axis ticks
#        axis.text.y=element_blank(),  #remove y axis labels
#        axis.ticks.y=element_blank(), #remove y axis ticks
#        legend.position="none",
#        legend.text = element_text(size = 4), 
#        legend.title = element_text(size = 5), 
#        legend.key.size = unit(0.08, 'cm')
#        ) + 
#  scale_fill_manual(values = c("blue", "lightblue", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
#  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
  #geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
#  geom_sf(data=melbourne_sd07aust_region, 
#          colour="black", 
#          fill=NA) +
#  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
#  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1)  + ggspatial::annotation_scale(location = 'br') + 
#  ggspatial::annotation_north_arrow(location = 'tr') +
#inset_element(pcol, left = 0.0, bottom = 0.0, right = 0.40, top =0.30) +
 # inset_element(pcol_mornington, left = 0.56, bottom = 0.04, right = 0.86, top =0.18) +
 # inset_element(pcol_south_east, left = 0.82, bottom = 0.04, right = 1.12, top =0.18) +
#  inset_element(pcol_inner_east, left = 0.78, bottom = 0.686, right = 1.08, top =0.83) +
#  inset_element(pcol_north_east, left = 0.59, bottom = 0.80, right = 0.89, top =0.95)  +
#  inset_element(pcol_north_west, left = 0.0, bottom = 0.81, right = 0.3, top =0.96) +
#  inset_element(pcol_west, left = 0.00, bottom = 0.30, right = 0.3, top =0.45) +
#  inset_element(pcol_inner, left = 0.17, bottom = 0.30, right = 0.47, top =0.45) +
#  inset_element(pcol_inner_south, left = 0.33, bottom = 0.25, right = 0.63, top =0.4) +
#  inset_element(pcol_outer_east, left = 0.82, bottom = 0.59, right = 1.12, top =0.72) 



```



```{r route_maps, fig.show="hold", eval = FALSE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE}


# import ptv feeds
ptv_160804_gtfs <- tidytransit::read_gtfs("data/ptv_160804/gtfs_duplicate_stops_removed.zip") 
ptv_210805_gtfs <- tidytransit::read_gtfs("data/ptv_210805/gtfs_duplicate_stops_removed.zip") 


###2021
## filter feed to only include Inner SA4

ptv_210805_gtfs <- tidytransit::filter_feed_by_area(ptv_210805_gtfs, sa42021 %>% filter(sa4_name_2021 == "Melbourne - Inner"))
#convert to sf
ptv_210805_gtfs <- tidytransit::gtfs_as_sf(ptv_210805_gtfs)
ptv_210805_gtfs <- tidytransit::get_route_geometry(ptv_210805_gtfs)


###2016
## filter feed to only include North East SA4s
ptv_160804_gtfs <- tidytransit::filter_feed_by_area(ptv_160804_gtfs, sa42021 %>% filter(sa4_name_2021 == "Melbourne - Inner"))
#convert to sf
ptv_160804_gtfs <- tidytransit::gtfs_as_sf(ptv_160804_gtfs)
ptv_160804_gtfs <- tidytransit::get_route_geometry(ptv_160804_gtfs)

```


```{r add_groupings, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE}


#sort SA1s into LGA of interest, Rest of SA4, Rest of Melbourne
sa1s_in_lga_of_interest <- sa12021 %>% select(sa1_code_2021) %>%
  st_filter(lga_of_interest_2021, .predicate =  st_intersects)
sa1s_in_lga_of_interest$group <- "City of Bayside"

sa1s_in_sa4_of_interest <- sa12021 %>% 
  st_drop_geometry()  %>%
  filter(sa4_name_2021 == "Melbourne - Inner South") %>%
  select(sa1_code_2021)
sa1s_in_sa4_of_interest <- sa1s_in_sa4_of_interest %>%
  left_join(sa1s_in_lga_of_interest %>% 
              st_drop_geometry())
sa1s_in_sa4_of_interest <- sa1s_in_sa4_of_interest %>%
  replace_na(list(group = "Rest of Inner South SA4"))

melbourne_si_SA12021_21_census_week_aggregated$si_by_area <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>% 
  left_join(sa1s_in_sa4_of_interest, 
            by =(join_by(area_id == sa1_code_2021)))
melbourne_si_SA12021_21_census_week_aggregated$si_by_area <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>% 
  replace_na(list(group = "Rest of Greater Melbourne"))

melbourne_2021_SA1_comparison <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group) %>% 
  chisq.test()

assumptions1 <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group)

assumptions2 <- melbourne_2021_SA1_comparison$expected


melbourne_2021_SA4_comparison <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group) %>% 
  chisq.test()

assumptions3 <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group)

assumptions4 <- melbourne_2021_SA4_comparison$expected



melbourne_si_SA12021_24_census_week_aggregated$si_by_area <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>% 
  left_join(sa1s_in_sa4_of_interest, 
            by =(join_by(area_id == sa1_code_2021)))
melbourne_si_SA12021_24_census_week_aggregated$si_by_area <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>% 
  replace_na(list(group = "Rest of Greater Melbourne"))

melbourne_2024_SA1_comparison <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group) %>% 
  chisq.test()

assumptions5 <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group) 

assumptions6 <- melbourne_2024_SA1_comparison$expected



melbourne_2024_SA4_comparison <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group) %>% 
  chisq.test()

assumptions7 <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(transit_supply = fct_drop(transit_supply)) %>% 
  tabyl(transit_supply, group)

assumptions8 <- melbourne_2024_SA4_comparison$expected

si_by_area_2021_2024_wider_holding <- si_by_area_2021_2024_wider_holding %>%
left_join(sa1s_in_sa4_of_interest, 
            by =(join_by(sa1_code_2021 == sa1_code_2021)))
si_by_area_2021_2024_wider_holding <- si_by_area_2021_2024_wider_holding %>% 
  replace_na(list(group = "Rest of Greater Melbourne"))


combined_needs_index_2021_sa1_greater_melbourne <- combined_needs_index_2021_sa1_greater_melbourne %>% left_join(sa1s_in_sa4_of_interest, 
            by =(join_by(sa1_code_2021 == sa1_code_2021)))
combined_needs_index_2021_sa1_greater_melbourne <- combined_needs_index_2021_sa1_greater_melbourne %>% 
  replace_na(list(group = "Rest of Greater Melbourne"))

combined_needs_index_2021_sa1_greater_melbourne <- combined_needs_index_2021_sa1_greater_melbourne %>%
  left_join(population_sa1_greater_melbourne_2021 %>% select(sa1_code_2021, population))


```

# Results


```{r SI_map, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, ncol = 2, out.width="50%", fig.height = 2.5, fig.cap="Transport Supply 2021 (left, by population) and 2024 (right, by SA1)"}


#Set boundings box
bbox_list <- lapply(st_geometry(lga_of_interest_2016), st_bbox)

lat = c(bbox_list[[1]]["ymin"] %>% as.numeric(), bbox_list[[1]]["ymax"] %>% as.numeric())
lon = c(bbox_list[[1]]["xmin"] %>% as.numeric(), bbox_list[[1]]["xmax"] %>% as.numeric() + 0.45*(bbox_list[[1]]["xmax"] %>% as.numeric() - bbox_list[[1]]["xmin"] %>% as.numeric()))

Poly_Coord_df = data.frame(lon, lat)

poly <- Poly_Coord_df %>% 
  st_as_sf(coords = c("lon", "lat"), 
           crs = 4326) %>% 
  st_bbox() %>% 
  st_as_sfc()

pcol <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  filter(group == "City of Bayside") %>% 
  st_drop_geometry() %>%
  aggregate(population ~ transit_supply, sum) %>%
  right_join(tibble(transit_supply = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  replace_na(list(population = 0)) %>%
  mutate(transit_supply=factor(transit_supply, levels = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  arrange(transit_supply) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, perc, fill = transit_supply), colour="black") +
  scale_y_continuous(limits = c(0,2.2)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply,  1.6, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "City of Bayside",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  ) 


pcol_rest_SA4 <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  filter(group == "Rest of Inner South SA4") %>% 
  st_drop_geometry() %>%
  aggregate(population ~ transit_supply, sum) %>%
  right_join(tibble(transit_supply = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  replace_na(list(population = 0)) %>%
  mutate(transit_supply=factor(transit_supply, levels = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  arrange(transit_supply) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, perc, fill = transit_supply), colour="black") +
  scale_y_continuous(limits = c(0,2.2)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply,  1.6, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of Inner South SA4",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 




pcol_rest_melbourne <- melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  filter(group == "Rest of Greater Melbourne") %>% 
  st_drop_geometry() %>%
  st_drop_geometry() %>%
  aggregate(population ~ transit_supply, sum) %>%
  right_join(tibble(transit_supply = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  replace_na(list(population = 0)) %>%
  mutate(transit_supply=factor(transit_supply, levels = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  arrange(transit_supply) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(transit_supply, perc, fill = transit_supply), colour="black") +
  scale_y_continuous(limits = c(0,2.2)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply,  1.6, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of GCCSA",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 



ggplot()+ 
  geom_sf(data=melbourne_si_SA12021_21_census_week_aggregated$si_by_area %>%
  filter(group == "City of Bayside"),
          aes(fill = transit_supply), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none",
#        legend.text = element_text(size = 4), 
#        legend.title = element_text(size = 5), 
#        legend.key.size = unit(0.08, 'cm')
        ) + 
 scale_fill_manual(values = c("#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
#  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
#  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
#  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
 # geom_sf(data=absmapsdata::sa12021 %>% filter(sa4_name_2021 == "Melbourne - Inner South") %>% select(geometry), fill=NA, colour = "grey") +
#  geom_sf(data=ptv_210804_gtfs, colour="purple") + 
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1, colour = "darkgrey") +
  geom_sf(data=lga_of_interest_2021, fill=NA, colour = "purple", linewidth = 2) + 
    coord_sf(xlim = c(lon[1],lon[2]), 
           ylim = c(lat[1], lat[2])) +
 # ggspatial::annotation_scale(location = 'bl') +
  ggspatial::annotation_north_arrow(location = 'bl', height = unit(0.75, "cm"), width = unit(0.75, "cm")) + 
 inset_element(pcol, left = 0.55, bottom = 0.0, right = 1.0, top =0.33) +
 inset_element(pcol_rest_SA4, left = 0.73, bottom = 0.33, right = 1.0, top =0.66) +
 inset_element(pcol_rest_melbourne, left = 0.73, bottom = 0.66, right = 1.0, top =1.0) 



pcol <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  filter(group == "City of Bayside") %>% 
  st_drop_geometry() %>%
  tabyl(transit_supply) %>%
  mutate(transit_supply=factor(transit_supply, levels = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  untabyl() %>% 
  as_tibble () %>% 
  ggplot() + 
  geom_col(aes(transit_supply, percent, fill = transit_supply), colour="black") +
  scale_y_continuous(limits = c(0,2.2)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply, 1.6, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(n)} ({label_percent(accuracy = 1)(percent)})")), size = 2) +
   coord_flip() + 
scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "City of Bayside",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  ) 


pcol_rest_SA4 <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  filter(group == "Rest of Inner South SA4") %>% 
  st_drop_geometry() %>%
  tabyl(transit_supply) %>%
  mutate(transit_supply=factor(transit_supply, levels = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  untabyl() %>% 
  as_tibble () %>% 
  ggplot() + 
  geom_col(aes(transit_supply, percent, fill = transit_supply), colour="black") +
  scale_y_continuous(limits = c(0,2.2)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply,1.6, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(n)} ({label_percent(accuracy = 1)(percent)})")), size = 2) +
   coord_flip() + 
scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of Inner South",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 

pcol_rest_melbourne <- melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  filter(group == "Rest of Greater Melbourne") %>% 
  st_drop_geometry() %>%
  tabyl(transit_supply) %>%
  mutate(transit_supply=factor(transit_supply, levels = melbourne_si_SA12021_21_census_week_aggregated$si_by_area$transit_supply %>% levels())) %>%
  untabyl() %>% 
  as_tibble () %>% 
  ggplot() + 
  geom_col(aes(transit_supply, percent, fill = transit_supply), colour="black") +
  scale_y_continuous(limits = c(0,2.2)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(transit_supply,1.6, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(n)} ({label_percent(accuracy = 1)(percent)})")), size = 2) +
   coord_flip() + 
scale_fill_manual(values = c("white", "#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of GCCSA",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 



ggplot()+ 
  geom_sf(data=melbourne_si_SA12021_24_census_week_aggregated$si_by_area %>%
  filter(group == "City of Bayside"),
          aes(fill = transit_supply), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none",
#        legend.text = element_text(size = 4), 
#        legend.title = element_text(size = 5), 
#        legend.key.size = unit(0.08, 'cm')
        ) + 
 scale_fill_manual(values = c("#F9D8B1", "#F7C387", "#F29C33", "lightgreen", "#53A212", "darkgreen")) +
#  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
#  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
#  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
 # geom_sf(data=absmapsdata::sa12021 %>% filter(sa4_name_2021 == "Melbourne - Inner South") %>% select(geometry), fill=NA, colour = "grey") +
#  geom_sf(data=ptv_210804_gtfs, colour="purple") + 
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1, colour = "darkgrey") +
  geom_sf(data=lga_of_interest_2021, fill=NA, colour = "purple", linewidth = 2) + 
    coord_sf(xlim = c(lon[1],lon[2]), 
           ylim = c(lat[1], lat[2])) +
  ggspatial::annotation_scale(location = 'bl') +
 # ggspatial::annotation_north_arrow(location = 'bl', height = unit(0.75, "cm"), width = unit(0.75, "cm")) + 
 inset_element(pcol, left = 0.55, bottom = 0.0, right = 1.0, top =0.33) +
 inset_element(pcol_rest_SA4, left = 0.73, bottom = 0.33, right = 1.0, top =0.66) +
 inset_element(pcol_rest_melbourne, left = 0.73, bottom = 0.66, right = 1.0, top =1.0) 




```



```{r SI_change_map, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.height = 2.5, fig.cap="Change in SI score between 2021 and 2024 by SA1 and population"}



lat = c(bbox_list[[1]]["ymin"] %>% as.numeric(), bbox_list[[1]]["ymax"] %>% as.numeric())
lon = c(bbox_list[[1]]["xmin"] %>% as.numeric(), bbox_list[[1]]["xmax"] %>% as.numeric() + 1.75*(bbox_list[[1]]["xmax"] %>% as.numeric() - bbox_list[[1]]["xmin"] %>% as.numeric()))

Poly_Coord_df = data.frame(lon, lat)

poly <- Poly_Coord_df %>% 
  st_as_sf(coords = c("lon", "lat"), 
           crs = 4326) %>% 
  st_bbox() %>% 
  st_as_sfc()

si_by_area_2021_2024_wider_holding <- left_join(si_by_area_2021_2024_wider_holding, population_sa1_greater_melbourne_2021)

si_by_area_2021_2024_wider_holding$ratio_binned <- si_by_area_2021_2024_wider_holding$ratio_binned %>% fct_shift(1)

si_by_area_2021_2024_wider_holding$ratio_binned <- si_by_area_2021_2024_wider_holding$ratio_binned %>% fct_collapse("Not served in 2024" = c("Never served (black)", "Service withdrawn (magenta)")
)

pcol <- si_by_area_2021_2024_wider_holding %>%
  filter(group == "City of Bayside") %>% 
  st_drop_geometry() %>%
  na.omit() %>% 
  aggregate(population ~ ratio_binned, FUN = sum) %>%
  right_join(tibble(ratio_binned = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels())) %>%
  replace_na(list(population = 0)) %>%
  mutate(ratio_binned=factor(ratio_binned, levels = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels())) %>%
  arrange(ratio_binned) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(ratio_binned, perc, fill = ratio_binned), colour="black") +
  scale_x_discrete(drop=FALSE) +
  scale_y_continuous(limits = c(0,1.1)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, 0.9, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 1.3) +
   coord_flip() +
  scale_fill_manual(values = c("#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "black")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
 title = "City of Bayside",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
      plot.title = element_text(size = 4),
    axis.text.y = element_text(size = 3.5, hjust = 1),
    axis.text.x = element_blank())
 

pcol_rest_SA4 <- si_by_area_2021_2024_wider_holding %>%
  filter(group == "Rest of Inner South SA4") %>% 
  st_drop_geometry() %>%
  na.omit() %>% 
  aggregate(population ~ ratio_binned, FUN = sum) %>%
  right_join(tibble(ratio_binned = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels())) %>%
  replace_na(list(population = 0)) %>%
  mutate(ratio_binned=factor(ratio_binned, levels = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels())) %>%
  arrange(ratio_binned) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(ratio_binned, perc, fill = ratio_binned), colour="black") +
  scale_y_continuous(limits = c(0,1.1)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned,  0.9, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 1.3) +
   coord_flip() +
  scale_fill_manual(values = c("#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "black")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
 title = "Rest of Inner South SA4",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 4),
    axis.text.y = element_blank(),
    axis.text.x = element_blank())
 

pcol_rest_melbourne <- si_by_area_2021_2024_wider_holding %>%
  filter(group == "Rest of Greater Melbourne") %>% 
  st_drop_geometry() %>%
  na.omit() %>% 
  aggregate(population ~ ratio_binned, FUN = sum) %>%
  right_join(tibble(ratio_binned = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels())) %>%
  replace_na(list(population = 0)) %>%
  mutate(ratio_binned=factor(ratio_binned, levels = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels())) %>%
  arrange(ratio_binned) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
   geom_col(aes(ratio_binned, perc, fill = ratio_binned), colour="black") +
  scale_y_continuous(limits = c(0,1.1)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned,  .9, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 1.3) +
   coord_flip() +
  scale_fill_manual(values = c("#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "black")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
 title = "Rest of GCCSA",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
        plot.title = element_text(size = 4),
    axis.text.y = element_blank(),
    axis.text.x = element_blank())
 

si_by_area_2021_2024_wider_holding <- left_join(
  absmapsdata::sa12021, si_by_area_2021_2024_wider_holding
)

ggplot()+ 
  geom_sf(data=si_by_area_2021_2024_wider_holding %>% 
            filter(group == "City of Bayside"),
          aes(fill = ratio_binned), colour=NA) +  
  scale_fill_manual(values = c("#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "black")) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none",
#        legend.text = element_text(size = 4), 
#        legend.title = element_text(size = 5), 
#        legend.key.size = unit(0.08, 'cm')
        ) +
#  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
#  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
#  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
 # geom_sf(data=absmapsdata::sa12021 %>% filter(sa4_name_2021 == "Melbourne - Inner South") %>% select(geometry), fill=NA, colour = "grey") +
#  geom_sf(data=ptv_210804_gtfs, colour="purple") + 
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1, colour = "darkgrey") +
  geom_sf(data=lga_of_interest_2021, fill=NA, colour = "purple", linewidth = 1) + 
    coord_sf(xlim = c(lon[1],lon[2]), 
           ylim = c(lat[1], lat[2])) +
  ggspatial::annotation_scale(location = 'bl', height = unit(0.0625, "cm")) +
#  ggspatial::annotation_north_arrow(location = 'tl') + 
inset_element(pcol, left = 0.50, bottom = 0.50, right = 1.0, top =1.05) +
inset_element(pcol_rest_SA4, left = 0.4, bottom = 0.0, right = 0.7, top =0.52) +
inset_element(pcol_rest_melbourne, left = 0.70, bottom = 0.0, right = 1.00, top =0.52) 



melbourne_2024_SA1_comparison <- si_by_area_2021_2024_wider_holding %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(ratio_binned = fct_drop(ratio_binned)) %>% 
  tabyl(ratio_binned, group) %>% 
  chisq.test()

assumptions9 <- si_by_area_2021_2024_wider_holding %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(ratio_binned = fct_drop(ratio_binned)) %>% 
  tabyl(ratio_binned, group)

assumptions10 <- melbourne_2024_SA1_comparison$expected

si_by_area_2021_2024_wider_holding$sa4_group <- 
  if_else(si_by_area_2021_2024_wider_holding$group == "Rest of Greater Melbourne", "Rest of Greater Melbourne", "Inner South")

melbourne_2024_SA4_comparison <- si_by_area_2021_2024_wider_holding %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(ratio_binned = fct_drop(ratio_binned)) %>% 
  tabyl(ratio_binned, group) %>% 
  chisq.test()

assumptions11 <- si_by_area_2021_2024_wider_holding %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(ratio_binned = fct_drop(ratio_binned)) %>% 
  tabyl(ratio_binned, group) 

assumptions12 <- melbourne_2024_SA4_comparison$expected


```

In 2021 most of the City of Bayside's population lived in SA1s with Very High levels of transit (Figure 1, left)^[Differences between the City of Bayside and the Rest of the Inner South SA4, by SA1, are statistically significant in 2021 (`r prmisc::print_chi2(melbourne_2021_SA1_comparison)`) and 2024 (`r prmisc::print_chi2(melbourne_2024_SA1_comparison)`). Differences with the rest of Melbourne are also statistically significant (2021: `r prmisc::print_chi2(melbourne_2021_SA4_comparison)`, 2024:`r prmisc::print_chi2(melbourne_2024_SA4_comparison)`).]. However, as shown in Figure 2^[Differences are statistically significant (rest of the Inner South SA4: `r prmisc::print_chi2(melbourne_2024_SA1_comparison)`, & rest of GCCSA: `r prmisc::print_chi2(melbourne_2024_SA4_comparison)`)], the coverage and frequency of transit service appears to have reduced by 2024 more for those in the City of Bayside.

```{r Needs_and_change_map, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, ncol = 2, out.width="50%", fig.height = 2.5, fig.cap="2021 needs (left) and change in SI to 2024 for those SA1s with needs above average, but below average supply (by 2021 populations, right)"}





#Set boundings box
bbox_list <- lapply(st_geometry(lga_of_interest_2016), st_bbox)

lat = c(bbox_list[[1]]["ymin"] %>% as.numeric(), bbox_list[[1]]["ymax"] %>% as.numeric())
lon = c(bbox_list[[1]]["xmin"] %>% as.numeric(), bbox_list[[1]]["xmax"] %>% as.numeric() + 0.45*(bbox_list[[1]]["xmax"] %>% as.numeric() - bbox_list[[1]]["xmin"] %>% as.numeric()))

Poly_Coord_df = data.frame(lon, lat)

poly <- Poly_Coord_df %>% 
  st_as_sf(coords = c("lon", "lat"), 
           crs = 4326) %>% 
  st_bbox() %>% 
  st_as_sfc()

pcol <- combined_needs_index_2021_sa1_greater_melbourne %>%
  filter(group == "City of Bayside") %>% 
  st_drop_geometry() %>%
  na.omit() %>%
  aggregate(population ~ composite_needs, sum) %>%
  right_join(tibble(composite_needs = combined_needs_index_2021_sa1_greater_melbourne$composite_needs %>% levels() %>% fct_drop())) %>%
  na.omit %>%
  mutate(composite_needs=factor(composite_needs, levels = combined_needs_index_2021_sa1_greater_melbourne$composite_needs %>% levels() %>% fct_drop())) %>%
  arrange(composite_needs) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs), colour="black") +
  scale_y_continuous(limits = c(0,1.5)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs,  1.05, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "City of Bayside",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_text(size = 6, hjust = 1),
    axis.text.x = element_blank()
  ) 


pcol_rest_SA4 <- combined_needs_index_2021_sa1_greater_melbourne %>%
  filter(group == "Rest of Inner South SA4") %>% 
 st_drop_geometry() %>%
  na.omit() %>%
  aggregate(population ~ composite_needs, sum) %>%
  right_join(tibble(composite_needs = combined_needs_index_2021_sa1_greater_melbourne$composite_needs %>% levels() %>% fct_drop())) %>%
  na.omit %>%
  mutate(composite_needs=factor(composite_needs, levels = combined_needs_index_2021_sa1_greater_melbourne$composite_needs %>% levels() %>% fct_drop())) %>%
  arrange(composite_needs) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs), colour="black") +
  scale_y_continuous(limits = c(0,1.5)) +
  geom_hline(yintercept = 0)  + 
  scale_x_discrete(drop=FALSE) +
  geom_text(aes(composite_needs,  1.05, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of Inner South SA4",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 




pcol_rest_melbourne <- combined_needs_index_2021_sa1_greater_melbourne %>%
  filter(group == "Rest of Greater Melbourne") %>% 
 st_drop_geometry() %>%
  na.omit() %>%
  aggregate(population ~ composite_needs, sum) %>%
  right_join(tibble(composite_needs = combined_needs_index_2021_sa1_greater_melbourne$composite_needs %>% levels() %>% fct_drop())) %>%
  na.omit %>%
  mutate(composite_needs=factor(composite_needs, levels = combined_needs_index_2021_sa1_greater_melbourne$composite_needs %>% levels() %>% fct_drop())) %>%
  arrange(composite_needs) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(composite_needs, perc, fill = composite_needs), colour="black") +
  scale_y_continuous(limits = c(0,1.5)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(composite_needs,  1.05, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest of GCCSA",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 



ggplot()+ 
  geom_sf(data=combined_needs_index_2021_sa1_greater_melbourne %>%
  filter(group == "City of Bayside") %>% na.omit(),
          aes(fill = composite_needs), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        legend.position="none",
#        legend.text = element_text(size = 4), 
#        legend.title = element_text(size = 5), 
#        legend.key.size = unit(0.08, 'cm')
        ) + 
   scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) +
#  geom_sf(data=melbourne_sd07aust_region, fill = NA, linewidth = 0.5) +
#  geom_sf(data=middle_lga07aust_region, fill = NA, linewidth = 0.4) +
#  geom_sf(data=sa4_boundaries, fill = NA, colour="blue") +
 # geom_sf(data=absmapsdata::sa12021 %>% filter(sa4_name_2021 == "Melbourne - Inner South") %>% select(geometry), fill=NA, colour = "grey") +
#  geom_sf(data=ptv_210804_gtfs, colour="purple") + 
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1, colour = "darkgrey") +
  geom_sf(data=lga_of_interest_2021, fill=NA, colour = "purple", linewidth = 2) + 
    coord_sf(xlim = c(lon[1],lon[2]), 
           ylim = c(lat[1], lat[2])) +
#  ggspatial::annotation_scale(location = 'bl') +
  ggspatial::annotation_north_arrow(location = 'bl', height = unit(0.75, "cm"), width = unit(0.75, "cm")) + 
 inset_element(pcol, left = 0.55, bottom = 0.0, right = 1.0, top =0.33) +
 inset_element(pcol_rest_SA4, left = 0.73, bottom = 0.33, right = 1.0, top =0.66) +
 inset_element(pcol_rest_melbourne, left = 0.73, bottom = 0.66, right = 1.0, top =1.0) 












melbourne_2021_SA1_comparison_needs <- combined_needs_index_2021_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(composite_needs= fct_drop(composite_needs)) %>% 
  tabyl(composite_needs, group) %>% 
  untabyl()
melbourne_2021_SA1_comparison_needs <- melbourne_2021_SA1_comparison_needs[1:6,]
melbourne_2021_SA1_comparison_needs <- melbourne_2021_SA1_comparison_needs[2:3] %>% chisq.test()

assumptions13 <- combined_needs_index_2021_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  mutate(composite_needs= fct_drop(composite_needs)) %>% 
  tabyl(composite_needs, group)

assumptions14 <- melbourne_2021_SA1_comparison_needs$expected


melbourne_2021_SA4_comparison_needs <- combined_needs_index_2021_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(composite_needs= fct_drop(composite_needs)) %>% 
  tabyl(composite_needs, group) %>% 
  untabyl()
melbourne_2021_SA4_comparison_needs <- melbourne_2021_SA4_comparison_needs[1:6,]
melbourne_2021_SA4_comparison_needs <- melbourne_2021_SA4_comparison_needs[2:3] %>% chisq.test()

assumptions15 <- combined_needs_index_2021_sa1_greater_melbourne %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  mutate(composite_needs= fct_drop(composite_needs)) %>% 
  tabyl(composite_needs, group)

assumptions16 <- melbourne_2021_SA4_comparison_needs$expected


### Above average Needs, below average supply only

si_by_area_2021_2024_wider_holding$ratio_binned_less <- if_else(
  si_by_area_2021_2024_wider_holding$x2024 == 0, 
  "No 2024 service",
  if_else(
      si_by_area_2021_2024_wider_holding$ratio < 0.99, 
      "-1% or lower", 
      if_else(si_by_area_2021_2024_wider_holding$ratio < 1.01, 
              "Within 1%", 
                      "+1% or more")))
                                              
                      
si_by_area_2021_2024_wider_holding$ratio_binned_less <- factor(
  si_by_area_2021_2024_wider_holding$ratio_binned_less, 
   levels = c("+1% or more",
              "Within 1%",
              "-1% or lower",
              "No 2024 service"
              )
  )
     

si_by_area_2021_2024_wider_holding <- si_by_area_2021_2024_wider_holding %>%
  left_join(combined_needs_index_2021_sa1_greater_melbourne %>% 
              st_drop_geometry() %>% 
              select(sa1_code_2021, composite_needs))


si_by_area_2021_2024_wider_holding <- si_by_area_2021_2024_wider_holding %>% 
  left_join(sa1s_in_sa4_of_interest)
si_by_area_2021_2024_wider_holding <- si_by_area_2021_2024_wider_holding %>% 
  replace_na(list(group = "Rest of Greater Melbourne"))



#si_by_area_2021_2024_wider_holding$ratio_binned_less <- 
#  si_by_area_2021_2024_wider_holding$ratio_binned_less %>% fct_collapse("Within 10%" = c("Increased 5 to 10%", "Within 5%", "Reduced 5 to 10%"))


melbourne_2021_SA1_comparison_very_high_needs <- si_by_area_2021_2024_wider_holding %>% 
             filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  tabyl(ratio_binned, group) %>%
  chisq.test()

assumptions17 <- si_by_area_2021_2024_wider_holding %>% 
             filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  tabyl(ratio_binned, group) 

assumptions18 <- melbourne_2021_SA1_comparison_very_high_needs$expected


melbourne_2021_SA1_comparison_very_high_needs <- si_by_area_2021_2024_wider_holding %>% 
             filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Inner South SA4") %>%
  tabyl(ratio_binned, group) %>%
chisq.test()

assumptions19 <- si_by_area_2021_2024_wider_holding %>% 
             filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  tabyl(ratio_binned, group)

melbourne_2021_SA4_comparison_very_high_needs <- si_by_area_2021_2024_wider_holding %>% 
             filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
  st_drop_geometry() %>% 
  filter(group == "City of Bayside" | group == "Rest of Greater Melbourne") %>%
  tabyl(ratio_binned, group) %>%
  chisq.test()

assumptions20 <- melbourne_2021_SA4_comparison_very_high_needs$expected 




pcol <- si_by_area_2021_2024_wider_holding %>%
  filter(group == "City of Bayside") %>% 
  st_drop_geometry() %>%
   filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
 na.omit() %>%
  aggregate(population ~ ratio_binned, sum) %>%
  mutate(ratio_binned=factor(ratio_binned, levels = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels() %>% fct_drop())) %>%
  arrange(ratio_binned) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned), colour="black") +
  scale_y_continuous(limits = c(0,1)) +
  scale_x_discrete(drop=FALSE) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, 0.7, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
   scale_fill_manual(values = c("#6D9DC4", "#A6CFE1","#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "black")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "City of Bayside",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 



pcol_rest_melbourne <- si_by_area_2021_2024_wider_holding %>%
  filter(group == "Rest of Inner South SA4" | group == "Rest of Greater Melbourne") %>% 
  st_drop_geometry() %>%
   filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
  na.omit() %>%
  aggregate(population ~ ratio_binned, sum) %>%
  mutate(ratio_binned=factor(ratio_binned, levels = si_by_area_2021_2024_wider_holding$ratio_binned %>% levels() %>% fct_drop())) %>%
  arrange(ratio_binned) %>%
  mutate(perc=population/sum(population)) %>% 
  ggplot() + 
  geom_col(aes(ratio_binned, perc, fill = ratio_binned), colour="black") +
  scale_y_continuous(limits = c(0,1)) +
  geom_hline(yintercept = 0)  + 
  geom_text(aes(ratio_binned, 0.7, label = glue::glue("{label_comma(accuracy = 1, big.mark = ",")(population)} ({label_percent(accuracy = 1)(perc)})")), size = 2) +
   coord_flip() + 
scale_fill_manual(values = c("#3A65A3", "#6D9DC4", "#A6CFE1", "#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "black")) +
  scale_color_manual(values = c(rep("black", 5), rep("white", 2), "black")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "Rest",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 7),
    axis.text.y = element_blank(),
    axis.text.x = element_blank()
  ) 



ggplot() + 
  geom_sf(data=si_by_area_2021_2024_wider_holding %>% 
  filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>%
  filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>%
  filter(group == "City of Bayside") %>% na.omit(),
          aes(fill = ratio_binned), colour=NA) +  
 scale_fill_manual(values = c("#3A65A3", "#A6CFE1","#DDEFF5", "#FFFBB5", "#F9D785", "#EFA15C", "#DC6446", "#BA3832", "#852128", "black")) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(), #remove y axis ticks
        plot.title = element_blank(),
        legend.position="none") +
  geom_sf(data=melbourne_railway_trips_shape_2021, linetype = "twodash", size = 0.1, colour = "darkgrey") +
  geom_sf(data=lga_of_interest_2021, fill=NA, colour = "purple", linewidth = 2) + 
    coord_sf(xlim = c(lon[1],lon[2]), 
           ylim = c(lat[1], lat[2])) +
  ggspatial::annotation_scale(location = 'bl') +
 # ggspatial::annotation_north_arrow(location = 'bl', height = unit(0.75, "cm"), width = unit(0.75, "cm")) + 
 inset_element(pcol, left = 0.7, bottom = 0.5, right = 1.0, top =1.0) +
 inset_element(pcol_rest_melbourne, left = 0.70, bottom = 0.0, right = 1.0, top =0.5) 

```



Social needs for transport in the City of Bayside in 2021 were High or Very High for more than half the population (Figure 3, left), more than for other parts of Melbourne^[Statistically significant for City of Bayside vs rest of Inner South:`r prmisc::print_chi2(melbourne_2021_SA1_comparison_needs)`, and vs rest of GCCSA `r prmisc::print_chi2(melbourne_2021_SA4_comparison_needs)`).]. Figure 3 (right) shows how transit service levels changed between 2021 and 2024 for those who were living in SA1s with needs above, but supply below the GCCSA average^[Fisher's tests show no significant differences between the City of Bayside and the rest of the Inner South SA4 (p = `r melbourne_2021_SA1_comparison_very_high_needs$p.value %>% format(digits = 3)`) or the Rest of the GCCSA (p = `r melbourne_2021_SA4_comparison_very_high_needs$p.value %>% format(digits = 3)`).]. Those SA1s with the largest gaps in the City of Bayside in 2021 mostly have similar levels of, or more, transit in 2024. 

Overall, the City of Bayside appears well supplied with transit and, compared to other parts of Greater Melbourne, has lower gaps between social needs and transit supply^[Only `r label_percent(accuracy = 0.1)(si_by_area_2021_2024_wider_holding %>% filter(group == "City of Bayside") %>% st_drop_geometry() %>% filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>% filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>% na.omit() %>% select(population) %>% sum() / si_by_area_2021_2024_wider_holding %>% filter(group == "City of Bayside") %>% st_drop_geometry() %>% select(population) %>% sum())` of residents in SA1s in the City of Bayside had above average social needs for transport but below average transit supply, compared with `r label_percent(accuracy = 0.1)(si_by_area_2021_2024_wider_holding %>% filter(group == "Rest of Inner South SA4") %>% st_drop_geometry() %>% filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>% filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>% na.omit() %>% select(population) %>% sum() / si_by_area_2021_2024_wider_holding %>% filter(group == "Rest of Inner South SA4") %>% st_drop_geometry() %>% select(population) %>% sum())` in the rest of the Inner South SA4 and `r label_percent(accuracy = 0.1)(si_by_area_2021_2024_wider_holding %>% filter(group == "Rest of Greater Melbourne") %>% st_drop_geometry() %>% filter(composite_needs == "Very High" | composite_needs == "High" | composite_needs == "Above average") %>% filter(transit_supply_2021 == "Below average" | transit_supply_2021 == "Low" | transit_supply_2021 == "Very Low" | transit_supply_2021 == "Zero Supply") %>% na.omit() %>% select(population) %>% sum() / si_by_area_2021_2024_wider_holding %>% filter(group == "Rest of Greater Melbourne") %>% st_drop_geometry() %>% select(population) %>% na.omit() %>% sum())` across the rest of Melbourne.]. Those with the largest needs-gaps in 2021 appear to have similar or more transit in 2024. 

```{r Check_assumptions, fig.show="hold", eval = TRUE, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE}

assumptions1
assumptions2
#1 of 10, assumption met. 
assumptions3
assumptions4
#none, assumption met.
assumptions5
assumptions6
#1 of 6, 
assumptions7
assumptions8
assumptions9
assumptions10
assumptions11
assumptions12
assumptions13
assumptions14
assumptions15
assumptions16
assumptions17
assumptions18
assumptions19
assumptions20

```



```{r, include=FALSE}
knitr::write_bib(file = 'packages.bib')
```
 
